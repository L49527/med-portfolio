<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>醫學評量批次助手 v24.3.48</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { font-size: clamp(12px, 1.1vw, 15px); }
        body { font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif; background-color: #f8fafc; overflow: hidden; }
        
        #sidebar { transition: width 0.3s ease-in-out; width: 60px; z-index: 150; }
        #sidebar.expanded { width: 320px; }
        #sidebarContent { opacity: 0; visibility: hidden; transition: opacity 0.2s; white-space: nowrap; }
        #sidebar.expanded #sidebarContent { opacity: 1; visibility: visible; white-space: normal; }

        .adaptive-text { font-size: 1rem; line-height: 1.5; }
        .adaptive-feedback { font-size: 1.05rem; font-weight: 600; line-height: 1.6; color: #0f172a; }
        .adaptive-title { font-size: 1.35rem; font-weight: 950; letter-spacing: -0.02em; }
        .adaptive-score { font-size: clamp(30px, 3.5vw, 85px); font-weight: 1000; line-height: 1; }
        
        .compare-table { width: 100%; table-layout: fixed; border-collapse: collapse; }
        .compare-table th { background-color: #f8fafc; position: sticky; top: 0; z-index: 10; border-bottom: 2px solid #e2e8f0; padding: 0.5rem; font-size: 0.8rem; font-weight: 900; text-align: center; }
        .compare-table td { padding: 6px 10px; border-right: 1px solid #f1f5f9; border-bottom: 1px solid #f1f5f9; vertical-align: top; word-break: break-all; overflow: hidden; }
        
        .chart-card { background: white; border-radius: 2.5rem; padding: 2rem; box-shadow: 0 15px 35px -5px rgba(0,0,0,0.08); border: 1px solid #f1f5f9; position: relative; }
        .download-btn { position: absolute; top: 1.5rem; right: 1.5rem; color: #cbd5e1; transition: all 0.2s; cursor: pointer; z-index: 200; }
        .download-btn:hover { color: #e11d48; transform: scale(1.2); }
        
        .filter-btn { 
            background-color: #f1f5f9; color: #64748b; border: 2px solid #e2e8f0; 
            padding: clamp(6px, 0.7vw, 10px) clamp(14px, 1.2vw, 20px);
            font-size: clamp(13px, 1vw, 16px);
            font-weight: 900; border-radius: 9999px; transition: all 0.2s;
        }
        .filter-btn.active-filter { background-color: #e11d48 !important; color: white !important; border-color: #e11d48 !important; box-shadow: 0 4px 10px rgba(225, 29, 72, 0.3); }
        
        .mode-active { border-bottom: 4px solid white !important; background-color: rgba(255,255,255,0.15) !important; transform: scale(1.05); }
        .slide-up { animation: slideUp 0.3s ease-out forwards; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .vertical-text { writing-mode: vertical-lr; letter-spacing: 0.1em; }
        .drop-active { background-color: #fff1f2 !important; border-color: #f43f5e !important; }
    </style>
</head>
<body class="h-screen flex flex-col text-slate-800 bg-slate-50">

    <header class="bg-slate-900 text-white px-6 py-3 flex justify-between items-center shadow-xl z-[200]">
        <div class="flex items-center gap-4">
            <div class="bg-rose-500 p-0.5 rounded-lg shadow-lg">
                <div class="bg-slate-900 rounded p-1.5 w-8 h-8 flex items-center justify-center font-bold text-rose-400 text-lg font-mono tracking-tighter">24</div>
            </div>
            <div>
                <h1 class="text-base font-black text-white leading-tight">醫學評量批次助手 <span class="text-rose-400">v24.3.48</span></h1>
                <p class="text-[10px] text-slate-400 italic tracking-widest uppercase italic">Dashboard Redraw Fix & Student Identity Locked</p>
            </div>
        </div>
        
        <div class="flex gap-2 text-white">
            <button id="cardModeBtn" onclick="switchView('card')" class="px-5 py-1.5 rounded-xl font-black transition flex items-center gap-2 shadow-md hover:bg-slate-700 bg-slate-800 mode-active"><i class="fas fa-th-large"></i> <span>卡片模式</span></button>
            <button id="compareModeBtn" onclick="switchView('compare')" class="px-5 py-1.5 rounded-xl font-black transition flex items-center gap-2 shadow-md hover:bg-blue-700 bg-blue-600"><i class="fas fa-right-left"></i> <span>互比模式</span></button>
            <button id="chartModeBtn" onclick="switchView('chart')" class="px-5 py-1.5 rounded-xl font-black transition flex items-center gap-2 shadow-md hover:bg-indigo-700 bg-indigo-600"><i class="fas fa-award"></i> <span>成果展看板</span></button>
            <div class="w-px bg-slate-700 mx-1"></div>
            <button onclick="exportToCSV()" class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-1.5 rounded-xl font-black transition flex items-center gap-2 shadow-md text-sm"><i class="fas fa-file-csv"></i> 匯出 CSV</button>
            <button onclick="clearHistory()" class="bg-slate-800 hover:bg-red-600 px-3 py-1.5 rounded-lg transition text-xs"><i class="fas fa-trash-alt"></i></button>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden relative">
        <div id="sidebar" class="bg-white border-r border-slate-200 flex flex-col shadow-xl z-30 relative">
            <button onclick="toggleSidebar()" class="w-full py-8 flex flex-col items-center gap-4 hover:bg-rose-50 text-rose-600 transition-all border-b border-slate-100 flex-none">
                <i id="sidebarIcon" class="fas fa-angles-right text-xl"></i>
                <span id="sidebarBtnLabel" class="text-[9px] font-black uppercase vertical-text">開啟匯入區</span>
            </button>

            <div id="sidebarContent" class="p-6 flex-1 overflow-hidden flex flex-col">
                <div class="mb-4 text-rose-600 font-bold flex items-center gap-2 text-base"><i class="fas fa-file-circle-plus"></i><span>批次資料匯入</span></div>
                <div id="dropZone" class="border-4 border-dashed border-slate-200 rounded-[2.5rem] flex-1 flex flex-col items-center justify-center p-6 transition-all hover:border-rose-400 hover:bg-rose-50 group cursor-pointer shadow-inner bg-slate-50">
                    <i class="fas fa-cloud-arrow-up text-7xl text-slate-200 group-hover:text-rose-400 mb-6 transition-transform group-hover:scale-110"></i>
                    <p class="text-xl font-black text-slate-500 group-hover:text-rose-600 text-center leading-tight tracking-tighter">將 HTML / CSV<br>丟入此處匯入</p>
                    <input type="file" id="fileInput" multiple accept=".html,.htm,.csv" class="hidden">
                </div>
            </div>
        </div>

        <div class="flex-1 flex flex-col bg-slate-100 overflow-hidden relative">
            <div class="bg-white px-10 py-4 border-b border-slate-200 flex flex-wrap items-center justify-between gap-4 shadow-sm z-10 font-black">
                <div class="flex flex-wrap items-center gap-3">
                    <button onclick="setFilter('all')" id="f_all" class="filter-btn active-filter">全部顯示</button>
                    <button onclick="setFilter('Milestone')" id="f_Milestone" class="filter-btn text-rose-600">里程碑</button>
                    <button onclick="setFilter('DOPS')" id="f_DOPS" class="filter-btn text-purple-600">DOPS</button>
                    <button onclick="setFilter('Mini-CEX')" id="f_Mini-CEX" class="filter-btn text-orange-600">Mini-CEX</button>
                    <button onclick="setFilter('EPA')" id="f_EPA" class="filter-btn text-blue-600">EPA</button>
                </div>
                <button onclick="toggleSort()" class="bg-slate-50 hover:bg-rose-50 text-slate-600 px-5 py-2.5 rounded-2xl text-sm font-black border border-slate-200 shadow-sm transition-colors">
                    <i class="fas fa-arrows-up-down text-rose-500" id="sortIcon"></i>
                    <span id="sortText">日期：新到舊</span>
                </button>
            </div>
            
            <div class="flex-1 p-6 overflow-y-auto" id="historyContainer">
                <div id="emptyState" class="h-full flex flex-col items-center justify-center text-slate-300 opacity-40 text-center leading-loose">
                    <i class="fas fa-layer-group text-9xl mb-6"></i>
                    <p class="text-xl font-light tracking-widest uppercase italic">請由左側展開並匯入檔案</p>
                </div>
            </div>
            <div class="hidden flex-1 p-6 overflow-auto bg-white shadow-inner" id="compareContainer"></div>
            <div class="hidden flex-1 p-8 overflow-auto bg-slate-100" id="chartContainer">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8" id="chartGrid"></div>
            </div>
        </div>
    </div>

    <div id="progressOverlay" class="hidden fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[300] flex items-center justify-center">
        <div class="bg-white p-8 rounded-[3rem] shadow-2xl flex flex-col items-center max-w-sm w-full relative border border-slate-100">
            <div class="loading-ring mb-4"></div>
            <p id="progressText" class="font-bold text-lg text-slate-700 text-center tracking-tighter">系統同步解析中...</p>
            <div class="w-full bg-slate-100 h-2 rounded-full mt-6 overflow-hidden shadow-inner border border-slate-50">
                <div id="progressBar" class="bg-rose-500 h-full transition-all duration-300" style="width: 0%"></div>
            </div>
        </div>
    </div>

    <script>
        let historyData = [];
        let currentFilter = 'all';
        let sortDirection = 'desc';
        let charts = {};

        const TARGET_MILESTONES = ["一、醫學影像及放射科學知識 1：放射診斷造影相關知識能力","一、醫學影像及放射科學知識 2：儀器品保與輻射安全","二、醫病關係及團隊溝通能力 1：與其他專業團隊之有效溝通","二、醫病關係及團隊溝通能力 2：與病人及陪同者之妥善溝通","三、病人照護 1：放射診斷造影技術","三、病人照護 2：儀器設備異常狀況處理","三、病人照護 3：病人安全","三、病人照護 4：任務交接","三、病人照護 5：跨領域團隊合作照護","四、提升本職技能 1： 提升本職技能","五、專業素養 1：專業價值","五、專業素養 2：責任擔當"];
        const OPA_VALUE_MAP = { 'N/A': 0, '1': 1, '2A': 2, '2B': 3, '3A': 4, '3B': 5, '3C': 6, '4': 7, '5': 8 };
        const OPA_LABEL_MAP = { 0: 'N/A', 1: '1', 2: '2a', 3: '2b', 4: '3a', 5: '3b', 6: '3c', 7: '4', 8: '5' };
        const CHART_COLORS = ['#3b82f6', '#10b981', '#f59e0b', '#7c3aed', '#e11d48', '#db2777', '#0891b2', '#475569'];

        function toggleSidebar() {
            const sb = document.getElementById('sidebar');
            sb.classList.toggle('expanded');
            document.getElementById('sidebarIcon').className = sb.classList.contains('expanded') ? 'fas fa-angles-left text-xl' : 'fas fa-angles-right text-xl';
            document.getElementById('sidebarBtnLabel').innerText = sb.classList.contains('expanded') ? '收合匯入區' : '開啟匯入區';
        }

        // --- 核心：視圖切換 (修正看板空白邏輯) ---
        function switchView(mode) {
            const hCont = document.getElementById('historyContainer');
            const cCont = document.getElementById('compareContainer');
            const chartCont = document.getElementById('chartContainer');
            const btns = { card: 'cardModeBtn', compare: 'compareModeBtn', chart: 'chartModeBtn' };

            hCont.classList.add('hidden'); cCont.classList.add('hidden'); chartCont.classList.add('hidden');
            Object.values(btns).forEach(id => document.getElementById(id).classList.remove('mode-active'));

            if (mode === 'card') {
                hCont.classList.remove('hidden'); document.getElementById('cardModeBtn').classList.add('mode-active'); renderCards();
            } else if (mode === 'compare') {
                cCont.classList.remove('hidden'); document.getElementById('compareModeBtn').classList.add('mode-active'); generateCompareTables();
            } else if (mode === 'chart') {
                chartCont.classList.remove('hidden'); document.getElementById('chartModeBtn').classList.add('mode-active');
                // 關鍵修正：確保容器顯示後再繪圖
                setTimeout(() => { generateExhibitionDashboard(); }, 100);
            }
        }

        function getGradeStyle(val) {
            if (!val) return 'bg-slate-50 text-slate-300';
            const v = val.toString().toUpperCase().trim();
            const styles = { '5':'bg-indigo-600 text-white','4':'bg-emerald-500 text-white','3C':'bg-sky-500 text-white','3B':'bg-blue-400 text-white','3A':'bg-cyan-400 text-slate-800','2B':'bg-amber-500 text-white','2A':'bg-orange-300 text-slate-800','1':'bg-rose-500 text-white','N/A':'bg-slate-300 text-slate-600' };
            return styles[v] || 'bg-slate-100 text-slate-500';
        }

        function getSmartGroupName(item) {
            const title = item.title;
            if (title.includes("頭頸部")) return "頭頸部";
            if (title.includes("胸腹部") || title.includes("胸部") || title.includes("腹部")) return "胸腹部";
            if (title.includes("CTA") || title.includes("Dynamic")) return "CTA/Dynamic";
            if (title.includes("學前")) return "學前";
            if (title.includes("學中")) return "學中";
            if (title.includes("學後")) return "學後";
            return title.replace(/^(DOPS|Mini-CEX|CEX|EPA|Milestone)[-\s:_/]+/i, '').trim().split(/[-_\s/]/)[0] || "其他項目";
        }

        function extractFieldContent(rawHtml, label) {
            let rt = new RegExp(label + "[\\s\\S]*?<textarea[^>]*>([\\s\\S]*?)<\\/textarea>", "i");
            let ma = rawHtml.match(rt); if (ma && ma[1].trim()) return ma[1].trim();
            let rs = new RegExp(label + "[^<:：]{0,100}[:：]?\\s*(?:<[^>]+>\\s*)*([^<>\s][^<]{1,3000})", "i");
            let mb = rawHtml.match(rs); if (mb && mb[1].trim()) return mb[1].replace(/<[^>]*>?/gm, '').trim();
            return "";
        }

        function analyzeHTML(raw) {
            try {
                const textStream = raw.replace(/(\r\n|\n|\r)/gm, " ").replace(/\s+/g, " ");
                let item = { id: Math.random().toString(36).substr(2, 9), type: 'Unknown', title: (raw.match(/<title>(.*?)<\/title>/i)?.[1] || "未定義表單"), date: '1900-01-01', scoreRaw: '', skillName: '', feedbackGood: '', feedbackNeeds: '', studentFeedback: '', opaScores: { 1: '', 2: '', 3: '' }, opaFeedbacks: { 1: '', 2: '', 3: '' }, milestoneLevels: {}, details: [], studentName: '' };
                
                // 姓名抓取 (強化比對)
                let nm = raw.match(/<strong>(.*?)<\/strong><\/h3>/) || raw.match(/loginAccountName\s*=\s*'(.*?)'/) || raw.match(/評量學員：<\/p>[\s\S]*?<strong>(.*?)<\/strong>/i);
                item.studentName = nm ? nm[1].trim() : "未知學員";
                
                let dm = raw.match(/DateType[^>]*?value=["'](\d{4}[-\/]\d{1,2}[-\/]\d{1,2})["']/i);
                item.date = dm ? dm[1].replace(/\//g, '-') : (raw.match(/20\d{2}[-\/]\d{1,2}[-\/]\d{1,2}/g)?.pop()?.replace(/\//g, '-') || "1900-01-01");

                const upTitle = item.title.toUpperCase();
                if (upTitle.includes('DOPS')) item.type = 'DOPS';
                else if (upTitle.includes('CEX') || upTitle.includes('MINI-CEX')) item.type = 'Mini-CEX';
                else if (upTitle.includes('EPA')) item.type = 'EPA';
                else if (upTitle.includes('MILESTONE') || upTitle.includes('里程碑')) item.type = 'Milestone';

                if (item.type === 'DOPS' || item.type === 'Mini-CEX') {
                    item.scoreRaw = textStream.match(/(?:評量總分數|評量成績|總分)[^0-9]{0,20}(\d{1,3}(\.\d)?)/i)?.[1] || "--";
                    item.skillName = textStream.match(/(?:操作項目|技能名稱|題目)[^<:：]{0,30}[:：]?\s*(?:<[^>]+>\s*)*([^<>\s][^<]{2,150})/i)?.[1]?.trim() || "未指定";
                    item.feedbackGood = extractFieldContent(raw, "教師回饋意見-表現良好項目") || extractFieldContent(raw, "表現良好項目");
                    item.feedbackNeeds = extractFieldContent(raw, "教師回饋意見-建議加強項目") || extractFieldContent(raw, "建議加強項目");
                    item.studentFeedback = extractFieldContent(raw, "學員回饋意見");
                    if(item.skillName) item.details.push(`<div class="bg-slate-200 p-2 px-3 rounded-lg text-[13px] font-black border-l-4 border-slate-500 mb-2 leading-tight">項目：${item.skillName}</div>`);
                    if(item.feedbackGood) item.details.push(`<div class="adaptive-text mb-1 text-slate-700 font-medium tracking-tighter leading-snug"><span class="text-emerald-700 font-bold mr-1 italic">【良好】</span>${item.feedbackGood}</div>`);
                    if(item.feedbackNeeds) item.details.push(`<div class="adaptive-text mb-1 text-slate-700 font-medium tracking-tighter leading-snug"><span class="text-amber-700 font-bold mr-1 italic">【建議】</span>${item.feedbackNeeds}</div>`);
                    if(item.studentFeedback) item.details.push(`<div class="adaptive-text bg-blue-50 p-2 rounded-lg italic text-slate-800 font-bold shadow-inner mt-2"><span class="text-blue-800 font-black mr-2">學員回饋</span>${item.studentFeedback}</div>`);
                } else if (item.type === 'EPA') {
                    let opaSecs = raw.split(/一、主題：/i).slice(1); 
                    opaSecs.forEach((sec, idx) => { if (idx < 3) { let i = idx + 1; let sm = sec.match(/整體任務[\s\S]*?<input[^>]*checked[^>]*>[\s\S]*?<label[^>]*?>\s*([^<]+?)\s*<\/label>/i); if (sm) item.opaScores[i] = sm[1].trim(); let fm = sec.match(/其它質性回饋[\s\S]*?回饋[：:][\s\S]*?<textarea[^>]*>([\s\S]*?)<\/textarea>/i); if (fm) item.opaFeedbacks[i] = fm[1].trim(); item.details.push(`<div class="mt-1 border-l-2 border-blue-400 pl-3 py-1 bg-white rounded shadow-sm border border-slate-100"><div class="flex justify-between items-center mb-0.5 font-bold"><span class="text-[10px] text-blue-400 uppercase font-black tracking-widest">OPA ${i}</span><span class="px-2 py-0.5 rounded text-[10px] font-black border ${getGradeStyle(item.opaScores[i])}">${item.opaScores[i] || '?'}</span></div><div class="adaptive-text text-slate-700">${item.opaFeedbacks[i] || '無建議'}</div></div>`); } });
                } else if (item.type === 'Milestone') {
                    TARGET_MILESTONES.forEach(target => { let loc = textStream.search(new RegExp(target.replace(/[.*+?^${}()|[\]\\]/g, '\\$&').replace(/\s+/g, "\\s*"), 'i')); if (loc > -1) { let cm = textStream.substring(loc, loc + 5000).match(/<input[^>]*?\bchecked\b[^>]*?>[^<]*?<label[^>]*?>\s*Level\s*([1-5])/i); if (cm) { item.milestoneLevels[target] = cm[1]; item.details.push(`<div class="flex justify-between items-center py-1 border-b border-slate-50 adaptive-text font-black text-xs leading-tight tracking-tighter"><span class="text-slate-700">${target}</span><span class="px-2 py-0.5 rounded border ${getGradeStyle(cm[1])}">L${cm[1]}</span></div>`); } } });
                }
                return item;
            } catch (e) { return null; }
        }

        function analyzeCSV(content) {
            try {
                const rows = []; let row = []; let curr = ""; let inQuotes = false;
                for (let i = 0; i < content.length; i++) {
                    let char = content[i]; if (char === '"' && content[i+1] === '"') { curr += '"'; i++; } else if (char === '"') inQuotes = !inQuotes; else if (char === ',' && !inQuotes) { row.push(curr); curr = ""; } else if (char === '\n' && !inQuotes) { row.push(curr); rows.push(row); row = []; curr = ""; } else curr += char;
                }
                if (curr || row.length) { row.push(curr); rows.push(row); }
                const dataRows = rows.filter(r => r.length > 5 && r[0] !== "評量日期");
                const res = [];
                dataRows.forEach(r => {
                    let item = { id: Math.random().toString(36).substr(2, 9), type: r[2], studentName: r[1], date: r[0], title: r[3], scoreRaw: r[4], skillName: r[5], feedbackGood: r[12], feedbackNeeds: r[13], studentFeedback: r[14], opaScores: { 1: r[6], 2: r[8], 3: r[10] }, opaFeedbacks: { 1: r[7], 2: r[9], 3: r[11] }, milestoneLevels: {}, details: [] };
                    TARGET_MILESTONES.forEach((m, idx) => { if (r[15 + idx]) item.milestoneLevels[m] = r[15 + idx]; });
                    if (item.type === 'DOPS' || item.type === 'Mini-CEX') {
                        if(item.skillName) item.details.push(`<div class="bg-slate-200 p-2 px-3 rounded-lg text-[13px] font-black border-l-4 border-slate-500 mb-2 leading-tight">項目：${item.skillName}</div>`);
                        if(item.feedbackGood) item.details.push(`<div class="adaptive-text mb-1 text-slate-700 font-medium leading-snug"><span class="text-emerald-700 font-bold mr-1 italic">【良好】</span>${item.feedbackGood}</div>`);
                        if(item.feedbackNeeds) item.details.push(`<div class="adaptive-text mb-1 text-slate-700 font-medium leading-snug"><span class="text-amber-700 font-bold mr-1 italic">【建議】</span>${item.feedbackNeeds}</div>`);
                        if(item.studentFeedback) item.details.push(`<div class="adaptive-text bg-blue-50 p-2 rounded-lg italic text-slate-800 font-bold shadow-inner mt-2"><span class="text-blue-800 font-black mr-2">學員回饋</span>${item.studentFeedback}</div>`);
                    } else if (item.type === 'EPA') {
                        [1,2,3].forEach(i => { item.details.push(`<div class="mt-1 border-l-2 border-blue-400 pl-3 py-1 bg-white rounded shadow-sm border border-slate-100"><div class="flex justify-between items-center mb-0.5 font-bold"><span class="text-[10px] font-bold text-blue-400">OPA ${i}</span><span class="px-2 py-0.5 rounded text-[10px] border ${getGradeStyle(item.opaScores[i])}">${item.opaScores[i] || '?'}</span></div><div class="adaptive-text text-slate-700 font-medium">${item.opaFeedbacks[i] || '無建議'}</div></div>`); });
                    } else if (item.type === 'Milestone') {
                        TARGET_MILESTONES.forEach(target => { let lv = item.milestoneLevels[target]; if (lv) item.details.push(`<div class="flex justify-between items-center py-1 border-b border-slate-50 adaptive-text font-black text-xs"><span class="text-slate-700">${target}</span><span class="px-2 py-0.5 rounded border ${getGradeStyle(lv)}">L${lv}</span></div>`); });
                    }
                    res.push(item);
                });
                return res;
            } catch (e) { return null; }
        }

        async function downloadChart(btn, title) {
            const card = btn.closest('.chart-card');
            btn.style.visibility = 'hidden';
            const canvas = await html2canvas(card, { backgroundColor: "#ffffff", scale: 2 });
            btn.style.visibility = 'visible';
            const link = document.createElement('a');
            link.download = `${title}.png`;
            link.href = canvas.toDataURL('image/png', 1.0);
            link.click();
        }

        function generateExhibitionDashboard() {
            const grid = document.getElementById('chartGrid'); grid.innerHTML = '';
            Object.values(charts).forEach(c => { if(c) c.destroy(); }); charts = {};
            if (historyData.length === 0) return;
            const sorted = sortDataList([...historyData]).reverse();
            const studentName = historyData[0].studentName;

            const msData = sorted.filter(d => d.type === 'Milestone');
            if (msData.length > 0 && (currentFilter === 'all' || currentFilter === 'Milestone')) {
                const ds = msData.map((d, i) => ({ label: `日期: ${d.date}`, data: TARGET_MILESTONES.map(m => parseInt(d.milestoneLevels[m]) || 0), borderColor: CHART_COLORS[i % CHART_COLORS.length], backgroundColor: hexToRgba(CHART_COLORS[i % CHART_COLORS.length], 0.1), borderWidth: 2 }));
                createChart(`【${studentName}】MILESTONE 核心成長成長疊加`, 'radar', TARGET_MILESTONES.map(m => m.split('：')[1].substr(0,10)), ds, null, { r: { min: 0, max: 5, ticks: { stepSize: 1 } } });
            }
            const epaData = sorted.filter(d => d.type === 'EPA');
            if (epaData.length > 0 && (currentFilter === 'all' || currentFilter === 'EPA')) {
                const groups = {}; epaData.forEach(d => { const g = getSmartGroupName(d); if(!groups[g]) groups[g]=[]; groups[g].push(d); });
                for(let k in groups) {
                    const ds = [1, 2, 3].map(i => ({ label: `OPA ${i}`, data: groups[k].map(d => (OPA_VALUE_MAP[d.opaScores[i]?.toUpperCase()] || 0) + (i * 0.1)), borderColor: CHART_COLORS[i-1], pointRadius: 6, borderWidth: 3, fill: false }));
                    createChart(`【${studentName}】EPA 信賴趨勢 - ${k}`, 'line', groups[k].map(d => d.date), ds, null, { y: { min: 0, max: 8, ticks: { callback: v => OPA_LABEL_MAP[Math.round(v)] || '', font: { weight: 'bold' } } } });
                }
            }
            const skillData = sorted.filter(d => d.type === 'DOPS' || d.type === 'Mini-CEX');
            if (skillData.length > 0) {
                const groups = {}; skillData.forEach(d => { const g = getSmartGroupName(d); if(!groups[g]) groups[g]=[]; groups[g].push(d); });
                for(let k in groups) {
                    if (currentFilter !== 'all' && !groups[k].some(d => d.type === currentFilter)) continue;
                    createChart(`【${studentName}】${groups[k][0].type} 得分曲線 - ${k}`, 'line', groups[k].map(d => d.date), [{ label: '總分', data: groups[k].map(d => parseFloat(d.scoreRaw) || 0), borderColor: '#e11d48', tension: 0.1, fill: false, pointRadius: 6 }], null, { y: { min: 0, max: 100 } });
                }
            }
        }

        function createChart(title, type, labels, dataOrDatasets, colors, scales) {
            const id = `chart_${Math.random().toString(36).substr(2, 9)}`;
            const datasets = Array.isArray(dataOrDatasets[0]) || typeof dataOrDatasets[0] === 'object' ? dataOrDatasets : [{ data: dataOrDatasets, backgroundColor: colors }];
            const card = document.createElement('div'); card.className = 'chart-card slide-up';
            card.innerHTML = `<div class="download-btn" onclick="downloadChart(this, '${title}')"><i class="fas fa-camera text-xl"></i></div><h3 class="adaptive-title text-slate-800 mb-6 border-l-[12px] border-rose-500 pl-4 italic tracking-tighter font-black">${title}</h3><div class="h-[300px]"><canvas id="${id}"></canvas></div>`;
            document.getElementById('chartGrid').appendChild(card);
            const ctx = document.getElementById(id).getContext('2d');
            charts[id] = new Chart(ctx, { type, data: { labels, datasets }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } }, scales: scales || {} } });
        }

        // --- 匯入區與基本 ---
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(e => { dropZone.addEventListener(e, (evt) => { evt.preventDefault(); evt.stopPropagation(); }, false); });
        dropZone.addEventListener('drop', (e) => handleFiles(e.dataTransfer.files));
        dropZone.onclick = () => fileInput.click();
        fileInput.onchange = (e) => handleFiles(e.target.files);

        async function handleFiles(files) { 
            if (!files || files.length === 0) return; 
            document.getElementById('progressOverlay').classList.remove('hidden'); 
            for (let i = 0; i < files.length; i++) { 
                const text = await files[i].text(); 
                const result = files[i].name.toLowerCase().endsWith('.csv') ? analyzeCSV(text) : analyzeHTML(text);
                if (result) { if (Array.isArray(result)) historyData.push(...result); else historyData.push(result); }
            } 
            document.getElementById('progressOverlay').classList.add('hidden'); 
            switchView('card'); 
        }

        function renderCards() {
            const container = document.getElementById('historyContainer');
            let filtered = currentFilter === 'all' ? historyData : historyData.filter(d => d.type === currentFilter);
            filtered.sort((a, b) => sortDirection === 'desc' ? b.date.localeCompare(a.date) : a.date.localeCompare(b.date));
            if (filtered.length === 0) { container.innerHTML = `<div class="h-full flex flex-col items-center justify-center text-slate-200 opacity-40 text-center"><i class="fas fa-layer-group text-[12rem] mb-10 text-slate-100"></i><p class="text-3xl font-black uppercase tracking-widest">請匯入評量檔案</p></div>`; return; }
            container.innerHTML = filtered.map(d => `<div class="bg-white rounded-3xl p-8 mb-6 shadow-xl border border-slate-200 flex justify-between gap-8 slide-up relative group"><button onclick="deleteItem('${d.id}')" class="absolute top-4 right-4 text-slate-200 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-all text-xl"><i class="fas fa-circle-xmark"></i></button><div class="flex-1 min-w-0"><div class="flex items-center gap-4 mb-3"><span class="text-[10px] font-black px-3 py-1 rounded-lg ${d.type === 'EPA' ? 'bg-blue-600' : (d.type === 'Milestone' ? 'bg-rose-600' : (d.type === 'DOPS' ? 'bg-purple-600' : 'bg-orange-500'))} text-white uppercase shadow-md font-bold tracking-widest">${d.type}</span><span class="text-sm text-slate-500 font-bold bg-slate-50 px-2 py-1 rounded border border-slate-100 shadow-inner tracking-tighter"><i class="far fa-calendar-check mr-1 text-rose-500"></i>${d.date}</span><span class="text-xs text-slate-400 font-black">【${d.studentName}】</span></div><h3 class="adaptive-title text-slate-900 mb-3 leading-tight tracking-tighter font-black">${d.title}</h3><div class="space-y-2">${d.details.join('')}</div></div><div class="flex flex-col justify-center items-end min-w-[140px] border-l-2 border-slate-50 pl-8">
                        ${d.type === 'EPA' ? `<div class="flex flex-col gap-3">${[1,2,3].map(i => `<div class="border-2 rounded-2xl p-2 min-w-[110px] text-center shadow-sm ${getGradeStyle(d.opaScores[i])}"><span class="text-[10px] block uppercase opacity-80 mb-1 font-bold tracking-tighter font-black">OPA ${i}</span><span class="text-4xl font-black">${d.opaScores[i] || '?'}</span></div>`).join('')}</div>` : (d.type === 'DOPS' || d.type === 'Mini-CEX' ? `<div class="text-center"><div class="adaptive-score text-blue-700 font-mono drop-shadow-xl tracking-tighter font-black">${d.scoreRaw}</div><div class="adaptive-label text-slate-400 uppercase italic mt-4 tracking-widest font-black text-[11px]">Total Score</div></div>` : '')}
                    </div></div>`).join('');
        }

        function generateCompareTables() {
            const container = document.getElementById('compareContainer'); container.innerHTML = "";
            const sorted = sortDataList([...historyData]); if (sorted.length === 0) return;
            let html = `<div class="mb-4 border-b-2 border-slate-900 pb-1 flex justify-between items-center"><h2 class="adaptive-title text-slate-900 uppercase italic tracking-tighter"><i class="fas fa-chart-line text-rose-500 mr-2"></i>行政智慧互比彙整總表</h2></div>`;
            if (currentFilter === 'all' || currentFilter === 'Milestone') {
                const msData = sorted.filter(d => d.type === 'Milestone'); if (msData.length > 0) {
                    html += `<div class="bg-white rounded-3xl p-4 shadow-xl mb-8 border border-slate-200 overflow-x-auto slide-up"><h3 class="text-xs font-black text-rose-600 mb-2 border-b border-rose-100 pb-1 w-fit uppercase">互比 Milestone</h3><table class="compare-table"><thead><tr><th class="text-slate-400 w-1/4 text-left font-black italic tracking-widest text-xs">指標 / 日期</th>${msData.map(d => `<th class="font-black text-slate-800 bg-rose-50/50">${d.date}</th>`).join('')}</tr></thead><tbody class="adaptive-text font-black">`; TARGET_MILESTONES.forEach(target => { html += `<tr><td class="font-bold text-slate-600 border-r border-slate-50 tracking-tighter text-xs">${target}</td>${msData.map(d => `<td class="text-center"><span class="px-2 py-1 rounded font-black border ${getGradeStyle(d.milestoneLevels[target])}">${d.milestoneLevels[target] ? 'L'+d.milestoneLevels[target] : '-'}</span></td>`).join('')}</tr>`; }); html += `</tbody></table></div>`;
                }
            }
            const dopsData = sorted.filter(d => d.type === 'DOPS' || d.type === 'Mini-CEX');
            if (dopsData.length > 0) {
                const groups = {}; dopsData.forEach(d => { const g = `${d.type} - ${getSmartGroupName(d)}`; if(!groups[g]) groups[g]=[]; groups[g].push(d); });
                for(let g in groups) { if(currentFilter !== 'all' && !groups[g].some(d => d.type === currentFilter)) continue;
                    html += `<div class="bg-white rounded-3xl p-4 shadow-xl mb-8 border border-slate-200 overflow-x-auto slide-up"><div class="flex items-center gap-2 mb-3 border-b border-slate-100 pb-1"><span class="text-[10px] font-black px-2 py-0.5 rounded bg-indigo-600 text-white uppercase italic shadow-sm tracking-tighter">智慧互比</span><h3 class="text-sm font-black text-slate-800 tracking-tighter italic">${g}</h3></div><table class="compare-table"><thead><tr><th class="w-1/6 text-slate-400 font-bold uppercase text-left tracking-tighter italic text-xs">對照項 / 日期</th>${groups[g].map(d => `<th class="font-black text-slate-800 bg-slate-50">${d.date}</th>`).join('')}</tr></thead><tbody class="adaptive-text font-black text-slate-700">`; html += `<tr><td class="font-black text-slate-400 text-xs tracking-tighter text-center italic">項目題目</td>${groups[g].map(d => `<td class="font-bold text-slate-700 bg-slate-50/30 text-xs tracking-tight">${d.skillName}</td>`).join('')}</tr>`; html += `<tr><td class="font-black text-blue-600 italic text-center text-lg">總評分</td>${groups[g].map(d => `<td class="text-center adaptive-score text-slate-800 font-mono tracking-tighter font-black">${d.scoreRaw}</td>`).join('')}</tr>`; html += `<tr><td class="font-black text-emerald-700 text-center tracking-tighter">良好建議</td>${groups[g].map(d => `<td class="adaptive-feedback text-slate-700 font-bold min-w-[200px] bg-emerald-50/10 leading-snug">${d.feedbackGood || '-'}</td>`).join('')}</tr>`; html += `<tr><td class="font-black text-amber-700 text-center tracking-tighter">建議加強</td>${groups[g].map(d => `<td class="adaptive-feedback text-slate-700 font-bold min-w-[200px] bg-amber-50/10 leading-snug">${d.feedbackNeeds || '-'}</td>`).join('')}</tr>`; html += `<tr><td class="font-black text-blue-700 italic tracking-tighter text-center underline decoration-2">學員心得</td>${groups[g].map(d => `<td class="adaptive-feedback italic text-slate-700 min-w-[200px] bg-blue-50/10 shadow-inner font-black p-3">${d.studentFeedback || '-'}</td>`).join('')}</tr></tbody></table></div>`;
                }
            }
            const epaData = sorted.filter(d => d.type === 'EPA');
            if (epaData.length > 0 && (currentFilter === 'all' || currentFilter === 'EPA')) {
                const epaGroups = {}; epaData.forEach(d => { const g = getSmartGroupName(d); if(!epaGroups[g]) epaGroups[g]=[]; epaGroups[g].push(d); });
                for(let keyword in epaGroups) {
                    html += `<div class="bg-white rounded-3xl p-4 shadow-xl mb-8 border border-slate-200 overflow-x-auto slide-up"><h3 class="text-xs font-black text-blue-600 mb-2 border-b border-blue-100 pb-1 w-fit uppercase italic tracking-tighter text-left font-black tracking-widest">互比 EPA - ${keyword}</h3><table class="compare-table"><thead><tr><th class="w-1/6 text-slate-400 italic text-left tracking-tighter uppercase italic text-xs">日期 / 指標</th>${epaGroups[keyword].map(d => `<th class="font-black text-slate-800 bg-blue-50/50">${d.date}</th>`).join('')}</tr></thead><tbody class="adaptive-text">`; [1,2,3].forEach(i => { html += `<tr><td class="font-bold text-blue-500 border-t border-slate-50 pt-2 uppercase tracking-tighter font-black text-center text-xs">OPA ${i}</td>${epaGroups[keyword].map(d => `<td class="text-center pt-2 border-t border-slate-50"><span class="px-4 py-1.5 rounded-xl font-black text-2xl border-2 shadow-sm ${getGradeStyle(d.opaScores[i])}">${d.opaScores[i] || '-'}</span></td>`).join('')}</tr>`; html += `<tr><td class="text-xs font-black text-slate-400 border-none italic pb-2 text-center tracking-tighter">質性建議</td>${epaGroups[keyword].map(d => `<td class="adaptive-feedback text-slate-700 min-w-[200px] border-none pb-2 bg-slate-50/20 font-medium leading-tight">${d.opaFeedbacks[i] || '-'}</td>`).join('')}</tr>`; }); html += `</tbody></table></div>`;
                }
            }
            container.innerHTML = html;
        }

        function setFilter(f) { currentFilter = f; document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active-filter')); document.getElementById('f_' + f).classList.add('active-filter'); switchView(document.querySelector('.mode-active').id.replace('ModeBtn', '')); }
        function toggleSort() { sortDirection = sortDirection === 'desc' ? 'asc' : 'desc'; document.getElementById('sortIcon').className = `fas fa-sort-amount-${sortDirection === 'desc' ? 'down' : 'up'} text-rose-500`; document.getElementById('sortText').innerText = `日期：${sortDirection === 'desc' ? '新到舊' : '舊到新'}`; switchView(document.querySelector('.mode-active').id.replace('ModeBtn', '')); }
        function sortDataList(list) { return list.sort((a, b) => sortDirection === 'desc' ? b.date.localeCompare(a.date) : a.date.localeCompare(b.date)); }
        function hexToRgba(hex, alpha) { const r = parseInt(hex.slice(1, 3), 16), g = parseInt(hex.slice(3, 5), 16), b = parseInt(hex.slice(5, 7), 16); return `rgba(${r}, ${g}, ${b}, ${alpha})`; }
        function clearHistory() { if(confirm('確定要清空？')) { historyData = []; switchView('card'); } }
        function exportToCSV() { if (historyData.length === 0) return; let hs = ["評量日期", "姓名", "類型", "表單名稱", "總分", "操作項目", "OPA1成績", "OPA1回饋", "OPA2成績", "OPA2回饋", "OPA3成績", "OPA3回饋", "教師良好回饋", "教師待加強回饋", "學員心得回饋"]; TARGET_MILESTONES.forEach(m => hs.push(m)); let rows = [hs.join(',')]; sortDataList([...historyData]).forEach(item => { let r = [item.date, item.studentName, item.type, item.title, (item.type !== 'EPA' ? item.scoreRaw : ''), item.skillName, item.opaScores[1], item.opaFeedbacks[1], item.opaScores[2], item.opaFeedbacks[2], item.opaScores[3], item.opaFeedbacks[3], item.feedbackGood, item.feedbackNeeds, item.studentFeedback]; TARGET_MILESTONES.forEach(m => r.push(item.milestoneLevels[m] || '')); rows.push(r.map(v => `"${(v || '').toString().replace(/"/g, '""')}"`).join(',')); }); const blob = new Blob(["\ufeff" + rows.join('\n')], { type: 'text/csv;charset=utf-8;' }); const link = document.createElement("a"); link.href = URL.createObjectURL(blob); link.download = `醫學成果對照總表.csv`; link.click(); }
    </script>
</body>
</html>
