<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>醫學評量批次助手 v25.1 (QA+)</title>
    
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3063/3063176.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="醫學助手">
    <meta name="theme-color" content="#0f172a">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { font-size: clamp(12px, 1.1vw, 15px); }
        body { font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif; background-color: #f8fafc; overflow: hidden; }
        #sidebar { transition: width 0.3s ease-in-out; width: 60px; z-index: 150; }
        #sidebar.expanded { width: 320px; }
        #sidebarContent { opacity: 0; visibility: hidden; transition: opacity 0.2s; white-space: nowrap; }
        #sidebar.expanded #sidebarContent { opacity: 1; visibility: visible; white-space: normal; }
        .adaptive-text { font-size: 1rem; line-height: 1.5; }
        .adaptive-feedback { font-size: 1.05rem; font-weight: 600; line-height: 1.6; color: #0f172a; }
        .adaptive-title { font-size: 1.35rem; font-weight: 950; letter-spacing: -0.02em; }
        .adaptive-score { font-size: clamp(30px, 3.5vw, 85px); font-weight: 1000; line-height: 1; }
        .compare-table { width: 100%; table-layout: fixed; border-collapse: collapse; }
        .compare-table th { background-color: #f8fafc; position: sticky; top: 0; z-index: 10; border-bottom: 2px solid #e2e8f0; padding: 0.5rem; font-size: 0.8rem; font-weight: 900; text-align: center; }
        .compare-table td { padding: 6px 10px; border-right: 1px solid #f1f5f9; border-bottom: 1px solid #f1f5f9; vertical-align: top; word-break: break-all; overflow: hidden; }
        .chart-card { background: white; border-radius: 2.5rem; padding: 2.5rem; box-shadow: 0 15px 35px -5px rgba(0,0,0,0.08); border: 1px solid #f1f5f9; position: relative; }
        .filter-btn { background-color: #f1f5f9; color: #64748b; border: 2px solid #e2e8f0; padding: clamp(6px, 0.7vw, 10px) clamp(14px, 1.2vw, 20px); font-size: clamp(13px, 1vw, 16px); font-weight: 900; border-radius: 9999px; transition: all 0.2s; }
        .filter-btn.active-filter { background-color: #e11d48 !important; color: white !important; border-color: #e11d48 !important; box-shadow: 0 4px 10px rgba(225, 29, 72, 0.3); }
        .custom-select { background-color: #fff; border: 2px solid #e2e8f0; border-radius: 9999px; padding: 6px 14px; font-weight: 900; color: #1e293b; outline: none; transition: all 0.2s; cursor: pointer; font-size: 13px; }
        .custom-select:hover { border-color: #e11d48; }
        .mode-active { border-bottom: 4px solid white !important; background-color: rgba(255,255,255,0.15) !important; transform: scale(1.05); }
        .slide-up { animation: slideUp 0.3s ease-out forwards; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .vertical-text { writing-mode: vertical-lr; letter-spacing: 0.1em; }
        
        /* Admin Dashboard Styles */
        #adminDashboard { background-color: #1e293b; color: #e2e8f0; }
        .admin-card { background-color: #334155; border-radius: 1rem; padding: 1.5rem; border: 1px solid #475569; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3); }
        .admin-table th { background-color: #0f172a; color: #94a3b8; padding: 0.75rem; text-align: left; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.05em; border-bottom: 2px solid #475569; position: sticky; top: 0; }
        .admin-table td { padding: 0.75rem; border-bottom: 1px solid #475569; font-size: 0.9rem; vertical-align: top; }
        .admin-table tr:hover { background-color: #475569; }
        .tag-badge { display: inline-block; padding: 0.1rem 0.4rem; border-radius: 0.3rem; font-size: 0.7rem; font-weight: bold; margin-right: 0.3rem; margin-bottom: 0.2rem; }
        .highlight-match { background-color: rgba(251, 191, 36, 0.3); color: #fbbf24; padding: 0 2px; border-radius: 2px; }
    </style>
</head>
<body class="h-screen flex flex-col text-slate-800 bg-slate-50">

    <header class="bg-slate-900 text-white px-6 py-3 flex justify-between items-center shadow-xl z-[200] flex-none">
        <div class="flex items-center gap-4">
            <div class="bg-rose-500 p-0.5 rounded-lg shadow-lg">
                <div class="bg-slate-900 rounded p-1.5 w-8 h-8 flex items-center justify-center font-bold text-rose-400 text-lg font-mono tracking-tighter">25</div>
            </div>
            <div>
                <h1 class="text-base font-black text-white leading-tight">醫學評量批次助手 <span class="text-rose-400">v25.1</span></h1>
                <p class="text-[10px] text-slate-400 italic tracking-widest uppercase italic">Teacher Quality Audit Added</p>
            </div>
        </div>
        <div class="flex gap-2 text-white">
            <div id="normalModeBtns" class="flex gap-2">
                <button id="cardModeBtn" onclick="switchView('card')" class="px-5 py-1.5 rounded-xl font-black transition flex items-center gap-2 shadow-md hover:bg-slate-700 bg-slate-800 mode-active"><i class="fas fa-th-large"></i> <span>卡片模式</span></button>
                <button id="compareModeBtn" onclick="switchView('compare')" class="px-5 py-1.5 rounded-xl font-black transition flex items-center gap-2 shadow-md hover:bg-blue-700 bg-blue-600"><i class="fas fa-right-left"></i> <span>互比模式</span></button>
                <button id="chartModeBtn" onclick="switchView('chart')" class="px-5 py-1.5 rounded-xl font-black transition flex items-center gap-2 shadow-md hover:bg-indigo-700 bg-indigo-600"><i class="fas fa-award"></i> <span>成果展看板</span></button>
            </div>
            <div class="w-px bg-slate-700 mx-1"></div>
            <button onclick="toggleAdminMode()" id="adminBtn" title="後台管理模式" class="bg-slate-700 hover:bg-orange-500 text-white px-3 py-1.5 rounded-xl font-black transition flex items-center justify-center gap-2 shadow-md text-sm border border-slate-600 w-10"><i class="fas fa-wrench"></i></button>
            <div class="w-px bg-slate-700 mx-1"></div>
            <button onclick="exportToCSV()" class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-1.5 rounded-xl font-black transition flex items-center gap-2 shadow-md text-sm"><i class="fas fa-file-csv"></i> 匯出 CSV</button>
            <button onclick="clearHistory()" title="全部清空" class="bg-slate-800 hover:bg-red-600 px-3 py-1.5 rounded-lg transition text-xs"><i class="fas fa-trash-alt"></i></button>
        </div>
    </header>

    <div id="appContainer" class="flex flex-1 overflow-hidden relative">
        <div id="sidebar" class="bg-white border-r border-slate-200 flex flex-col shadow-xl z-30 relative">
            <button onclick="toggleSidebar()" class="w-full py-8 flex flex-col items-center gap-4 hover:bg-rose-50 text-rose-600 transition-all border-b border-slate-100 flex-none">
                <i id="sidebarIcon" class="fas fa-angles-right text-xl"></i>
                <span id="sidebarBtnLabel" class="text-[9px] font-black uppercase vertical-text">開啟匯入區</span>
            </button>
            <div id="sidebarContent" class="p-6 flex-1 overflow-hidden flex flex-col">
                <div class="mb-4 text-rose-600 font-bold flex items-center gap-2 text-base"><i class="fas fa-file-circle-plus"></i><span>批次資料匯入</span></div>
                <div id="dropZone" class="border-4 border-dashed border-slate-200 rounded-[2.5rem] flex-1 flex flex-col items-center justify-center p-6 transition-all hover:border-rose-400 hover:bg-rose-50 group cursor-pointer shadow-inner bg-slate-50">
                    <i class="fas fa-cloud-arrow-up text-7xl text-slate-200 group-hover:text-rose-400 mb-6 transition-transform group-hover:scale-110"></i>
                    <p class="text-xl font-black text-slate-500 group-hover:text-rose-600 text-center leading-tight tracking-tighter">將 HTML / CSV<br>丟入此處匯入</p>
                    <input type="file" id="fileInput" multiple accept=".html,.htm,.csv" class="hidden">
                </div>
            </div>
        </div>

        <div class="flex-1 flex flex-col bg-slate-100 overflow-hidden relative">
            <div class="bg-white px-10 py-4 border-b border-slate-200 flex flex-wrap items-center justify-between gap-4 shadow-sm z-10 font-black">
                <div class="flex flex-wrap items-center gap-3">
                    <button onclick="setFilter('all')" id="f_all" class="filter-btn active-filter">全部</button>
                    <button onclick="setFilter('Milestone')" id="f_Milestone" class="filter-btn text-rose-600">里程碑</button>
                    <button onclick="setFilter('DOPS')" id="f_DOPS" class="filter-btn text-purple-600">DOPS</button>
                    <button onclick="setFilter('Mini-CEX')" id="f_Mini-CEX" class="filter-btn text-orange-600">Mini-CEX</button>
                    <button onclick="setFilter('CbD')" id="f_CbD" class="filter-btn text-emerald-600">CbD</button>
                    <button onclick="setFilter('EPA')" id="f_EPA" class="filter-btn text-blue-600">EPA</button>
                    <div class="h-6 w-px bg-slate-200 mx-2"></div>
                    <select id="studentFilter" onchange="setStudentFilter(this.value)" class="custom-select border-blue-200 text-blue-800"><option value="all">所有學員</option></select>
                    <select id="trainingFilter" onchange="setTrainingFilter(this.value)" class="custom-select border-emerald-200 text-emerald-800"><option value="all">所有訓練別</option></select>
                </div>
                <button onclick="toggleSort()" class="bg-slate-50 hover:bg-rose-50 text-slate-600 px-5 py-2.5 rounded-2xl text-sm font-black border border-slate-200 shadow-sm transition-colors">
                    <i class="fas fa-arrows-up-down text-rose-500" id="sortIcon"></i>
                    <span id="sortText">日期：舊到新</span>
                </button>
            </div>
            
            <div class="flex-1 p-6 overflow-y-auto" id="historyContainer">
                <div id="emptyState" class="h-full flex flex-col items-center justify-center text-slate-300 opacity-40 text-center leading-loose">
                    <i class="fas fa-layer-group text-9xl mb-6"></i>
                    <p class="text-xl font-light tracking-widest uppercase italic">請由左側展開並匯入檔案</p>
                </div>
            </div>
            <div class="hidden flex-1 p-6 overflow-auto bg-white shadow-inner" id="compareContainer"></div>
            <div class="hidden flex-1 p-8 overflow-auto bg-slate-100" id="chartContainer">
                <div class="grid grid-cols-1 gap-8" id="chartGrid"></div>
            </div>
        </div>
    </div>

    <div id="adminDashboard" class="hidden flex-1 flex flex-col overflow-hidden">
        <div class="bg-slate-800 px-8 py-4 border-b border-slate-700 flex justify-between items-center shadow-lg z-20">
            <h2 class="text-xl font-black text-white italic tracking-widest"><i class="fas fa-user-shield text-orange-500 mr-2"></i>教學品管後台儀表板</h2>
            <div class="flex gap-3">
                 <div class="bg-slate-700 px-4 py-1 rounded text-xs text-slate-300 flex items-center gap-2">
                    <div class="w-2 h-2 rounded-full bg-green-500"></div> 正常
                    <div class="w-2 h-2 rounded-full bg-red-500 ml-2"></div> 警示 (內容過短/敷衍)
                 </div>
            </div>
        </div>
        
        <div class="flex-1 overflow-y-auto p-6 grid grid-cols-12 gap-6">
            
            <div class="col-span-12 lg:col-span-8 flex flex-col gap-6">
                <div class="admin-card h-[650px] flex flex-col">
                    <div class="flex justify-between items-center mb-4 border-b border-slate-600 pb-3">
                        <h3 class="text-lg font-bold text-orange-400"><i class="fas fa-comments mr-2"></i>師生回饋品質雙向檢核</h3>
                        <p class="text-xs text-slate-400">同時監測「教師填寫認真度」與「學生回饋針對性」</p>
                    </div>
                    <div class="flex-1 overflow-auto rounded-lg border border-slate-600">
                        <table class="admin-table w-full text-left border-collapse">
                            <thead>
                                <tr>
                                    <th class="w-32 text-center">日期 / 類型</th>
                                    <th class="w-5/12 text-indigo-400">
                                        <div class="flex justify-between items-center">
                                            <span>教師回饋內容 (優點 & 改善)</span>
                                            <span class="text-[10px] bg-indigo-900 px-2 rounded text-indigo-200">審核重點</span>
                                        </div>
                                    </th>
                                    <th class="w-4/12 text-blue-400">學生回饋</th>
                                    <th class="w-24 text-center">品質狀態</th>
                                </tr>
                            </thead>
                            <tbody id="feedbackAuditBody">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="col-span-12 lg:col-span-4 flex flex-col gap-6">
                <div class="admin-card">
                    <h3 class="text-lg font-bold text-sky-400 mb-4"><i class="fas fa-project-diagram mr-2"></i>分數 vs 能力對照</h3>
                    <p class="text-xs text-slate-400 mb-2">檢視 DOPS 分數 (Y) 與 Milestone/EPA Level (X) 相關性。理論應呈正相關。</p>
                    <div class="h-[250px]">
                        <canvas id="correlationChart"></canvas>
                    </div>
                </div>

                <div class="admin-card flex-1">
                    <h3 class="text-lg font-bold text-emerald-400 mb-4"><i class="fas fa-chalkboard-teacher mr-2"></i>教師評分偏好</h3>
                    <div class="h-[200px]">
                         <canvas id="teacherStatsChart"></canvas>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <div id="progressOverlay" class="hidden fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[300] flex items-center justify-center">
        <div class="bg-white p-8 rounded-[3rem] shadow-2xl flex flex-col items-center max-w-sm w-full relative border border-slate-100">
            <div class="loading-ring mb-4"></div>
            <p id="progressText" class="font-bold text-lg text-slate-700 text-center tracking-tighter">系統同步解析中...</p>
            <div class="w-full bg-slate-100 h-2 rounded-full mt-6 overflow-hidden shadow-inner border border-slate-50">
                <div id="progressBar" class="bg-rose-500 h-full transition-all duration-300" style="width: 0%"></div>
            </div>
        </div>
    </div>

    <script>
        let historyData = [];
        let currentFilter = 'all';
        let currentStudentFilter = 'all';
        let currentTrainingFilter = 'all';
        let sortDirection = 'asc'; 
        let charts = {};
        let adminCharts = {};
        let isAdminMode = false;

        const TARGET_MILESTONES = ["一、醫學影像及放射科學知識 1：放射診斷造影相關知識能力","一、醫學影像及放射科學知識 2：儀器品保與輻射安全","二、醫病關係及團隊溝通能力 1：與其他專業團隊之有效溝通","二、醫病關係及團隊溝通能力 2：與病人及陪同者之妥善溝通","三、病人照護 1：放射診斷造影技術","三、病人照護 2：儀器設備異常狀況處理","三、病人照護 3：病人安全","三、病人照護 4：任務交接","三、病人照護 5：跨領域團隊合作照護","四、提升本職技能 1： 提升本職技能","五、專業素養 1：專業價值","五、專業素養 2：責任擔當"];
        const CORE_COMPETENCIES = ["醫學影像知識", "團隊溝通能力", "病人照護核心", "本職技能提升", "專業素養表現"];
        const CORE_MAP = { "醫學影像知識": [0, 1], "團隊溝通能力": [2, 3], "病人照護核心": [4, 5, 6, 7, 8], "本職技能提升": [9], "專業素養表現": [10, 11] };
        const OPA_VALUE_MAP = { 'N/A': 0, '1': 1, '2A': 2, '2B': 3, '3A': 4, '3B': 5, '3C': 6, '4': 7, '5': 8 };
        const OPA_LABEL_MAP = { 0: 'N/A', 1: '1', 2: '2a', 3: '2b', 4: '3a', 5: '3b', 6: '3c', 7: '4', 8: '5' };
        const CHART_COLORS = ['#3b82f6', '#10b981', '#f59e0b', '#7c3aed', '#e11d48', '#db2777', '#0891b2', '#475569'];

        function toggleSidebar() {
            const sb = document.getElementById('sidebar');
            if(!sb) return;
            sb.classList.toggle('expanded');
            document.getElementById('sidebarIcon').className = sb.classList.contains('expanded') ? 'fas fa-angles-left text-xl' : 'fas fa-angles-right text-xl';
            document.getElementById('sidebarBtnLabel').innerText = sb.classList.contains('expanded') ? '收合匯入區' : '開啟匯入區';
        }

        function switchView(mode) {
            if(isAdminMode) toggleAdminMode(); // Force exit admin
            const hCont = document.getElementById('historyContainer');
            const cCont = document.getElementById('compareContainer');
            const chartCont = document.getElementById('chartContainer');
            if(!hCont || !cCont || !chartCont) return;

            hCont.classList.add('hidden'); cCont.classList.add('hidden'); chartCont.classList.add('hidden');
            const btns = { card: 'cardModeBtn', compare: 'compareModeBtn', chart: 'chartModeBtn' };
            Object.values(btns).forEach(id => { if(document.getElementById(id)) document.getElementById(id).classList.remove('mode-active'); });
            
            if (mode === 'card') { hCont.classList.remove('hidden'); document.getElementById('cardModeBtn').classList.add('mode-active'); renderCards(); } 
            else if (mode === 'compare') { cCont.classList.remove('hidden'); document.getElementById('compareModeBtn').classList.add('mode-active'); generateCompareTables(); } 
            else if (mode === 'chart') { chartCont.classList.remove('hidden'); document.getElementById('chartModeBtn').classList.add('mode-active'); setTimeout(() => { generateExhibitionDashboard(); }, 100); }
        }
        
        /* --- Admin Mode Logic --- */
        function toggleAdminMode() {
            isAdminMode = !isAdminMode;
            const app = document.getElementById('appContainer');
            const admin = document.getElementById('adminDashboard');
            const btn = document.getElementById('adminBtn');
            const normalBtns = document.getElementById('normalModeBtns');
            
            if (isAdminMode) {
                app.classList.add('hidden');
                admin.classList.remove('hidden');
                btn.classList.add('bg-orange-500', 'border-orange-400');
                btn.classList.remove('bg-slate-700');
                // Removed button text update logic
                normalBtns.classList.add('opacity-30', 'pointer-events-none');
                generateAdminDashboard();
            } else {
                app.classList.remove('hidden');
                admin.classList.add('hidden');
                btn.classList.remove('bg-orange-500', 'border-orange-400');
                btn.classList.add('bg-slate-700');
                normalBtns.classList.remove('opacity-30', 'pointer-events-none');
            }
        }

        function generateAdminDashboard() {
            if (historyData.length === 0) return;
            renderFeedbackAudit();
            renderCorrelationChart();
            renderTeacherStats();
        }

        function renderFeedbackAudit() {
            const tbody = document.getElementById('feedbackAuditBody');
            tbody.innerHTML = '';
            
            // Filter only items with potential feedback fields
            const feedbackData = historyData.filter(d => ['DOPS', 'Mini-CEX', 'CbD'].includes(d.type));
            const studentFeedbackHistory = {}; // To check for duplicates

            feedbackData.forEach(d => {
                const tr = document.createElement('tr');
                
                // Clean text for analysis
                const cleanGood = (d.feedbackGood || '').replace(/<[^>]*>?/gm, '').trim();
                const cleanNeeds = (d.feedbackNeeds || '').replace(/<[^>]*>?/gm, '').trim();
                const cleanFeedback = (d.studentFeedback || '').replace(/<[^>]*>?/gm, '').trim();
                
                // Check Student Quality
                let sQuality = 1; // 1:OK, 0:Bad
                let sMsg = "";
                let isDuplicate = false;
                
                if (cleanFeedback.length > 0) {
                    if (studentFeedbackHistory[d.studentName] && studentFeedbackHistory[d.studentName].includes(cleanFeedback)) isDuplicate = true;
                    if (!studentFeedbackHistory[d.studentName]) studentFeedbackHistory[d.studentName] = [];
                    studentFeedbackHistory[d.studentName].push(cleanFeedback);
                }

                if (cleanFeedback.length < 6 || ["無", "沒有", "謝謝", "謝謝老師", "good", "ok"].includes(cleanFeedback.toLowerCase())) {
                    sQuality = 0; sMsg = "學員敷衍";
                } else if (isDuplicate) {
                    sQuality = 0; sMsg = "學員複製";
                }

                // Check Teacher Quality
                let tQuality = 1; // 1:OK, 0:Bad
                let tMsg = "";
                if (cleanNeeds.length < 4 || ["無", "沒有", "none", "good", "ok"].includes(cleanNeeds.toLowerCase())) {
                    tQuality = 0; tMsg = "教師評語過短";
                }

                // Build Status Badge
                let statusHtml = '';
                if(sQuality === 1 && tQuality === 1) statusHtml = '<span class="tag-badge bg-green-500/20 text-green-400">雙方優良</span>';
                else {
                    if(tQuality === 0) statusHtml += `<div class="tag-badge bg-red-500/20 text-red-400 mb-1">⚠️ ${tMsg}</div>`;
                    if(sQuality === 0) statusHtml += `<div class="tag-badge bg-orange-500/20 text-orange-400">⚠️ ${sMsg}</div>`;
                }

                let displayGood = d.feedbackGood || '<span class="text-slate-600 italic">無</span>';
                let displayNeeds = d.feedbackNeeds || '<span class="text-slate-600 italic">無</span>';
                let displayFeedback = d.studentFeedback || '<span class="text-slate-600 italic">無</span>';

                tr.innerHTML = `
                    <td class="text-center align-top pt-4">
                        <div class="font-black text-slate-200">${d.studentName}</div>
                        <div class="text-[10px] text-slate-500 font-mono mt-1">${d.date}</div>
                        <span class="text-[10px] px-2 py-0.5 rounded bg-slate-700 text-slate-300 mt-2 inline-block">${d.type}</span>
                    </td>
                    <td class="text-slate-300 text-sm leading-relaxed p-4 border-l border-slate-700">
                        <div class="text-orange-400 font-bold text-xs mb-2 flex items-center"><i class="fas fa-user-tie mr-1"></i>${d.teacherName}</div>
                        <div class="mb-3 bg-slate-700/30 p-2 rounded border-l-2 border-emerald-500">
                            <div class="text-[10px] text-emerald-500 font-bold mb-1">【表現良好】</div>
                            <div class="text-xs text-slate-300">${displayGood}</div>
                        </div>
                        <div class="bg-slate-700/30 p-2 rounded border-l-2 border-orange-500">
                            <div class="text-[10px] text-orange-500 font-bold mb-1">【建議加強】</div>
                            <div class="text-xs text-slate-300">${displayNeeds}</div>
                        </div>
                    </td>
                    <td class="text-slate-300 text-sm leading-relaxed p-4 border-l border-slate-700 align-top">
                         <div class="text-blue-400 font-bold text-xs mb-2"><i class="fas fa-user-graduate mr-1"></i>學員回饋</div>
                         <div class="text-xs text-slate-300 bg-slate-700/30 p-2 rounded border-l-2 border-blue-500 min-h-[60px]">${displayFeedback}</div>
                    </td>
                    <td class="text-center align-top pt-4 border-l border-slate-700">
                        ${statusHtml}
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function renderCorrelationChart() {
            const ctx = document.getElementById('correlationChart').getContext('2d');
            if(adminCharts.corr) adminCharts.corr.destroy();
            
            const points = [];
            const students = [...new Set(historyData.map(d => d.studentName))];

            students.forEach(s => {
                const sData = historyData.filter(d => d.studentName === s);
                const dops = sData.filter(d => ['DOPS', 'Mini-CEX'].includes(d.type));
                const milestones = sData.filter(d => d.type === 'Milestone');
                
                if(dops.length > 0 && milestones.length > 0) {
                    // Calc Avg Score
                    const avgScore = dops.reduce((acc, curr) => acc + (parseFloat(curr.scoreRaw)||0), 0) / dops.length;
                    
                    // Calc Avg Level
                    let totalLvl = 0, countLvl = 0;
                    milestones.forEach(m => {
                         Object.values(m.milestoneLevels).forEach(l => {
                             if(l) { totalLvl += parseFloat(l); countLvl++; }
                         });
                    });
                    const avgLvl = countLvl ? (totalLvl / countLvl) : 0;

                    if(avgScore > 0 && avgLvl > 0) {
                        points.push({ x: avgLvl, y: avgScore, name: s });
                    }
                }
            });

            adminCharts.corr = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: '學員能力分佈 (平均 Milestone Level vs 平均 DOPS 分數)',
                        data: points,
                        backgroundColor: '#fbbf24'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { title: { display: true, text: '平均 Milestone Level (1-5)', color: '#94a3b8' }, grid: { color: '#334155' }, ticks: { color: '#94a3b8' } },
                        y: { title: { display: true, text: '平均 DOPS/CEX 分數', color: '#94a3b8' }, min: 60, max: 100, grid: { color: '#334155' }, ticks: { color: '#94a3b8' } }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.raw.name}: L${context.raw.x.toFixed(1)} / ${context.raw.y.toFixed(1)}分`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function renderTeacherStats() {
            const ctx = document.getElementById('teacherStatsChart').getContext('2d');
            if(adminCharts.teacher) adminCharts.teacher.destroy();

            const tStats = {};
            historyData.filter(d => ['DOPS', 'Mini-CEX'].includes(d.type)).forEach(d => {
                if(!tStats[d.teacherName]) tStats[d.teacherName] = { sum: 0, count: 0 };
                const s = parseFloat(d.scoreRaw);
                if(!isNaN(s)) {
                    tStats[d.teacherName].sum += s;
                    tStats[d.teacherName].count++;
                }
            });

            const labels = Object.keys(tStats);
            const data = labels.map(t => (tStats[t].sum / tStats[t].count).toFixed(1));

            adminCharts.teacher = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '教師平均給分',
                        data: data,
                        backgroundColor: '#10b981',
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { min: 70, max: 100, grid: { color: '#334155' }, ticks: { color: '#94a3b8' } },
                        x: { grid: { display: false }, ticks: { color: '#94a3b8' } }
                    }
                }
            });
        }
        /* ----------------------- */

        /* --- 關鍵輔助函式 (修復白畫面與分類問題) --- */
        function getSmartGroupName(item) {
            const title = item.title;
            const keywords = ["頭頸部", "胸腹部", "胸部", "腹部", "CTA", "Dynamic", "學前", "學中", "學後", "四肢部", "脊椎部", "Pancreas", "Liver"];
            for(let key of keywords) { if(title.includes(key)) return key; }
            return title.replace(/^(DOPS|Mini-CEX|CEX|CbD|EPA|Milestone)[-\s:_/]+/i, '').trim().split(/[-_\s/]/)[0] || "其他項目";
        }

        function deleteItem(id) { 
            if(confirm('確定要刪除此筆評量紀錄嗎？')) { 
                historyData = historyData.filter(item => item.id !== id); 
                updateFilterOptions(); 
                switchView(currentViewMode());
                if(isAdminMode) generateAdminDashboard();
            } 
        }

        function clearHistory() {
            if(confirm('確定要清空所有資料嗎？此動作無法復原。')) {
                historyData = [];
                updateFilterOptions();
                switchView('card');
            }
        }

        function getGradeStyle(val) {
            if (!val) return 'bg-slate-50 text-slate-300';
            const v = val.toString().toUpperCase().trim();
            const styles = { '5':'bg-indigo-600 text-white','4':'bg-emerald-500 text-white','3C':'bg-sky-500 text-white','3B':'bg-blue-400 text-white','3A':'bg-cyan-400 text-slate-800','2B':'bg-amber-500 text-white','2A':'bg-orange-300 text-slate-800','1':'bg-rose-500 text-white','N/A':'bg-slate-300 text-slate-600' };
            return styles[v] || 'bg-slate-100 text-slate-500';
        }
        
        function extractFieldContent(rawHtml, label) {
            let rt = new RegExp(label + "[\\s\\S]*?<textarea[^>]*>([\\s\\S]*?)<\\/textarea>", "i");
            let ma = rawHtml.match(rt); if (ma && ma[1].trim()) return ma[1].trim();
            let rs = new RegExp(label + "[^<:：]{0,100}[:：]?\\s*(?:<[^>]+>\\s*)*([^<>\s][^<]{1,3000})", "i");
            let mb = rawHtml.match(rs); if (mb && mb[1].trim()) return mb[1].replace(/<[^>]*>?/gm, '').trim();
            return "";
        }
        /* ------------------------------------------- */

        function analyzeHTML(raw) {
            if (!raw) return null;
            try {
                const textStream = raw.replace(/(\r\n|\n|\r)/gm, " ").replace(/\s+/g, " ");
                let item = { id: Math.random().toString(36).substr(2, 9), type: 'Unknown', trainingType: '未分類', title: (raw.match(/<title>(.*?)<\/title>/i)?.[1] || "未定義表單"), date: '1900-01-01', scoreRaw: '', skillName: '', feedbackGood: '', feedbackNeeds: '', studentFeedback: '', opaScores: { 1: '', 2: '', 3: '' }, opaFeedbacks: { 1: '', 2: '', 3: '' }, milestoneLevels: {}, details: [], studentName: '未知學員', teacherName: '未註明' };
                
                let snmMatch = raw.match(/<h3[^>]*><strong>\s*([\u4e00-\u9fa5]{2,5})\s*<\/strong><\/h3>/i) || 
                               raw.match(/評量學員：[\s\S]*?<strong>\s*([\u4e00-\u9fa5]{2,5})\s*<\/strong>/i) ||
                               raw.match(/([\u4e00-\u9fa5]{2,5})\(學員\)/i);
                if (snmMatch) item.studentName = snmMatch[1].trim();
                
                let tnmSign = raw.match(/<td[^>]*class=["']e_signature_name["'][^>]*>([\u4e00-\u9fa5]{2,10})<\/td>/i);
                let tnmFlow = raw.match(/([\u4e00-\u9fa5]{2,5})\(臨床教師\)/i);
                let tnmInput = raw.match(/(?:評量教師|臨床教師姓名|指導教師)[^]{0,1000}value=["']((?!關閉|列印|提交|清除)[\u4e00-\u9fa5]{2,10})["']/i);
                if (tnmSign) item.teacherName = tnmSign[1].trim();
                else if (tnmFlow) item.teacherName = tnmFlow[1].trim();
                else if (tnmInput) item.teacherName = tnmInput[1].trim();

                let trm = raw.match(/<dt>階段\/子階段：<\/dt>\s*<dd[^>]*>(.*?)<\/dd>/i);
                if (trm) {
                    let fullPath = trm[1].replace(/<[^>]*>?/gm, '').trim();
                    item.trainingType = fullPath.split('/').pop() || "未分類";
                }

                let dm = raw.match(/DateType[^>]*?value=["'](\d{4}[-\/]\d{1,2}[-\/]\d{1,2})["']/i);
                item.date = dm ? dm[1].replace(/\//g, '-') : (raw.match(/20\d{2}[-\/]\d{1,2}[-\/]\d{1,2}/g)?.pop()?.replace(/\//g, '-') || "1900-01-01");

                const upTitle = item.title.toUpperCase();
                if (upTitle.includes('DOPS')) item.type = 'DOPS';
                else if (upTitle.includes('CBD')) item.type = 'CbD';
                else if (upTitle.includes('CEX') || upTitle.includes('MINI-CEX')) item.type = 'Mini-CEX';
                else if (upTitle.includes('EPA')) item.type = 'EPA';
                else if (upTitle.includes('MILESTONE') || upTitle.includes('里程碑')) item.type = 'Milestone';

                if (['DOPS', 'Mini-CEX', 'CbD'].includes(item.type)) {
                    item.scoreRaw = textStream.match(/(?:評量總分數|評量成績|總分)[^0-9.]{0,20}(\d{1,3}(\.\d)?)/i)?.[1] || "--";
                    item.skillName = textStream.match(/(?:操作項目|技能名稱|操作技能名稱|題目)[^<:：]{0,30}[:：]?\s*(?:<[^>]+>\s*)*([^<>\s][^<]{2,150})/i)?.[1]?.trim() || "未指定";
                    item.feedbackGood = extractFieldContent(raw, "教師回饋意見-表現良好項目") || extractFieldContent(raw, "表現良好項目");
                    item.feedbackNeeds = extractFieldContent(raw, "教師回饋意見-建議加強項目") || extractFieldContent(raw, "建議加強項目");
                    item.studentFeedback = extractFieldContent(raw, "學員回饋意見");
                } else if (item.type === 'EPA') {
                    for (let i = 1; i <= 3; i++) {
                        let scoreRe = new RegExp(`OPA\\s*${i}[\\s\\S]*?<input[^>]*checked[^>]*>[\\s\\S]*?<label[^>]*?>\\s*([^<]+?)\\s*<`, "i");
                        let sm = raw.match(scoreRe); if (sm) item.opaScores[i] = sm[1].trim();
                        let fbRe = new RegExp(`(?:OPA\\s*${i}[^]*?)(?:其它質性回饋|回饋[：:])[\\s\\S]*?<textarea[^>]*>([\\s\\S]*?)<\\/textarea>`, "i");
                        let fm = raw.match(fbRe); if (fm) item.opaFeedbacks[i] = fm[1].trim();
                    }
                } else if (item.type === 'Milestone') {
                    TARGET_MILESTONES.forEach(target => {
                        let loc = textStream.search(new RegExp(target.replace(/[.*+?^${}()|[\]\\]/g, '\\$&').replace(/\s+/g, "\\s*"), 'i'));
                        if (loc > -1) {
                            let block = textStream.substring(loc, loc + 3000);
                            let cm = block.match(/<input[^>]*?\bchecked\b[^>]*?>[^<]*?<label[^>]*?>\s*(?:Level\s*)?([1-5])/i);
                            if (cm) item.milestoneLevels[target] = cm[1];
                        }
                    });
                }
                buildItemDetails(item);
                return item;
            } catch (e) { console.error("Parse error", e); return null; }
        }

        function buildItemDetails(item) {
            item.details = [];
            item.details.push(`<div class="mb-2 text-[11px] font-black text-slate-400 bg-slate-50 px-2 py-0.5 rounded border inline-block tracking-tighter">訓練別：${item.trainingType}</div>`);
            if (['DOPS', 'Mini-CEX', 'CbD'].includes(item.type)) {
                if(item.skillName) item.details.push(`<div class="bg-slate-200 p-2 px-3 rounded-lg text-[13px] font-black border-l-4 border-slate-500 mb-2 leading-tight">項目：${item.skillName}</div>`);
                if(item.feedbackGood) item.details.push(`<div class="adaptive-text mb-1 text-slate-700 font-medium leading-snug"><span class="text-emerald-700 font-bold mr-1 italic">【表現良好】</span>${item.feedbackGood}</div>`);
                if(item.feedbackNeeds) item.details.push(`<div class="adaptive-text mb-1 text-slate-700 font-medium leading-snug"><span class="text-amber-700 font-bold mr-1 italic">【建議加強】</span>${item.feedbackNeeds}</div>`);
                if(item.studentFeedback) item.details.push(`<div class="adaptive-text bg-blue-50 p-2 rounded-lg italic text-slate-800 font-bold border border-blue-100 shadow-inner mt-2"><span class="text-blue-800 font-black mr-2">學員回饋</span>${item.studentFeedback}</div>`);
            } else if (item.type === 'EPA') {
                [1,2,3].forEach(i => { if(item.opaScores[i]) item.details.push(`<div class="mt-1 border-l-2 border-blue-400 pl-3 py-1 bg-white rounded shadow-sm border border-slate-100"><div class="flex justify-between items-center mb-0.5 font-bold"><span class="text-[10px] text-blue-400 font-black uppercase">OPA ${i}</span><span class="px-2 py-0.5 rounded text-[10px] font-black border ${getGradeStyle(item.opaScores[i])}">${item.opaScores[i]}</span></div><div class="adaptive-text text-slate-700">${item.opaFeedbacks[i] || '無具體建議'}</div></div>`); });
            } else if (item.type === 'Milestone') {
                TARGET_MILESTONES.forEach(target => { if (item.milestoneLevels[target]) item.details.push(`<div class="flex justify-between items-center py-1 border-b border-slate-50 adaptive-text font-black text-xs leading-tight"><span class="text-slate-700">${target}</span><span class="px-2 py-0.5 rounded border ${getGradeStyle(item.milestoneLevels[target])}">L${item.milestoneLevels[target]}</span></div>`); });
            }
        }

        function analyzeCSV(content) {
            try {
                const rows = []; let row = []; let curr = ""; let inQuotes = false;
                for (let i = 0; i < content.length; i++) {
                    let char = content[i]; if (char === '"' && content[i+1] === '"') { curr += '"'; i++; } else if (char === '"') inQuotes = !inQuotes; else if (char === ',' && !inQuotes) { row.push(curr); curr = ""; } else if (char === '\n' && !inQuotes) { row.push(curr); rows.push(row); row = []; curr = ""; } else curr += char;
                }
                if (curr || row.length) { row.push(curr); rows.push(row); }
                const dataRows = rows.filter(r => r.length > 5 && r[0] !== "評量日期");
                const res = [];
                dataRows.forEach(r => {
                    let item = { id: Math.random().toString(36).substr(2, 9), date: r[0], studentName: r[1], type: r[2], title: r[3], scoreRaw: r[4], skillName: r[5], opaScores: { 1: r[6], 2: r[8], 3: r[10] }, opaFeedbacks: { 1: r[7], 2: r[9], 3: r[11] }, feedbackGood: r[12], feedbackNeeds: r[13], studentFeedback: r[14], teacherName: r[15] || '未註明', trainingType: r[16] || '未分類', milestoneLevels: {}, details: [] };
                    TARGET_MILESTONES.forEach((m, idx) => { if (r[17 + idx]) item.milestoneLevels[m] = r[17 + idx]; });
                    buildItemDetails(item); res.push(item);
                });
                return res;
            } catch (e) { return null; }
        }

        function generateExhibitionDashboard() {
            const grid = document.getElementById('chartGrid'); grid.innerHTML = '';
            Object.values(charts).forEach(c => { if(c) c.destroy(); }); charts = {};
            const filtered = getFilteredData();
            if (filtered.length === 0) return;
            
            const studentGroups = {};
            filtered.forEach(d => {
                if(!studentGroups[d.studentName]) studentGroups[d.studentName] = [];
                studentGroups[d.studentName].push(d);
            });

            Object.keys(studentGroups).sort().forEach(sName => {
                const sData = sortDataList([...studentGroups[sName]]);
                // 1. Milestone (按學員區分)
                const msData = sData.filter(d => d.type === 'Milestone');
                if (msData.length > 0) {
                    const ds = msData.map((d, i) => {
                        const getAvg = (indices) => {
                            const vals = indices.map(idx => parseFloat(d.milestoneLevels[TARGET_MILESTONES[idx]])).filter(v => !isNaN(v));
                            return vals.length ? (vals.reduce((a, b) => a + b, 0) / vals.length).toFixed(1) : 0;
                        };
                        const coreValues = [ getAvg(CORE_MAP["醫學影像知識"]), getAvg(CORE_MAP["團隊溝通能力"]), getAvg(CORE_MAP["病人照護核心"]), parseFloat(d.milestoneLevels[TARGET_MILESTONES[9]]) || 0, getAvg(CORE_MAP["專業素養表現"]) ];
                        return { label: `日期: ${d.date}`, data: coreValues, borderColor: CHART_COLORS[i % CHART_COLORS.length], backgroundColor: hexToRgba(CHART_COLORS[i % CHART_COLORS.length], 0.15), borderWidth: 2.5 };
                    });
                    createChart(`【${sName}】MILESTONE 核心能力成長分析`, 'radar', CORE_COMPETENCIES, ds, { r: { min: 0, max: 5, ticks: { stepSize: 1 } } });
                }
                // 2. EPA (按學員+部位區分)
                const epaData = sData.filter(d => d.type === 'EPA');
                if (epaData.length > 0) {
                    const pg = {}; epaData.forEach(d => { const g = getSmartGroupName(d); if(!pg[g]) pg[g]=[]; pg[g].push(d); });
                    for(let k in pg) {
                        const ds = pg[k].map((d, i) => ({ label: `日期: ${d.date}`, data: [1, 2, 3].map(i => OPA_VALUE_MAP[d.opaScores[i]?.toUpperCase()] || 0), borderColor: CHART_COLORS[i % CHART_COLORS.length], backgroundColor: hexToRgba(CHART_COLORS[i % CHART_COLORS.length], 0.1), borderWidth: 2 }));
                        createChart(`【${sName}】EPA 信賴能力分析 (Radar) - ${k}`, 'radar', ["OPA 1", "OPA 2", "OPA 3"], ds, { r: { min: 0, max: 8, ticks: { callback: v => OPA_LABEL_MAP[Math.round(v)] || '', font: { weight: 'bold' } } } });
                    }
                }
                // 3. DOPS/Mini-CEX (按學員+部位區分)
                const skillData = sData.filter(d => ['DOPS', 'Mini-CEX', 'CbD'].includes(d.type));
                if (skillData.length > 0) {
                    const pg = {}; skillData.forEach(d => { const g = getSmartGroupName(d); if(!pg[g]) pg[g]=[]; pg[g].push(d); });
                    for(let k in pg) {
                        createChart(`【${sName}】${pg[k][0].type} 成長曲線 - ${k}`, 'line', pg[k].map(d => d.date), [{ label: '總分', data: pg[k].map(d => parseFloat(d.scoreRaw) || 0), borderColor: '#e11d48', tension: 0.1, fill: false, pointRadius: 6 }], { y: { min: 0, max: 100 } });
                    }
                }
            });
            const chartCards = grid.querySelectorAll('.chart-card');
            grid.className = (chartCards.length === 1) ? "grid grid-cols-1 gap-8" : "grid grid-cols-1 lg:grid-cols-2 gap-8";
        }

        function createChart(title, type, labels, datasets, scales) {
            const id = `chart_${Math.random().toString(36).substr(2, 9)}`;
            const card = document.createElement('div'); card.className = 'chart-card slide-up';
            card.innerHTML = `<h3 class="adaptive-title text-slate-800 mb-8 text-center font-black tracking-tighter">${title}</h3><div class="h-[380px] w-full"><canvas id="${id}"></canvas></div>`;
            document.getElementById('chartGrid').appendChild(card);
            const ctx = document.getElementById(id).getContext('2d');
            charts[id] = new Chart(ctx, { type, data: { labels, datasets }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { font: { weight: 'bold' } } } }, scales: scales || {} } });
        }

        function renderCards() {
            const container = document.getElementById('historyContainer');
            if(!container) return;
            let filtered = getFilteredData();
            filtered.sort((a, b) => sortDirection === 'desc' ? b.date.localeCompare(a.date) : a.date.localeCompare(b.date));
            if (filtered.length === 0) { container.innerHTML = `<div class="h-full flex flex-col items-center justify-center text-slate-200 opacity-40 text-center"><i class="fas fa-layer-group text-[12rem] mb-10 text-slate-100"></i><p class="text-3xl font-black uppercase tracking-widest">目前無符合條件資料</p></div>`; return; }
            container.innerHTML = filtered.map(d => `<div class="bg-white rounded-3xl p-8 mb-6 shadow-xl border border-slate-200 flex justify-between gap-8 slide-up relative group">
                    <button onclick="deleteItem('${d.id}')" class="absolute top-4 right-4 text-slate-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-all text-xl"><i class="fas fa-circle-xmark"></i></button>
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-4 mb-3">
                            <span class="text-[10px] font-black px-3 py-1 rounded-lg ${d.type === 'EPA' ? 'bg-blue-600' : (d.type === 'Milestone' ? 'bg-rose-600' : (d.type === 'DOPS' ? 'bg-purple-600' : (d.type === 'CbD' ? 'bg-emerald-600' : 'bg-orange-500')))} text-white uppercase shadow-md font-bold tracking-widest">${d.type}</span>
                            <span class="text-sm text-slate-500 font-bold bg-slate-50 px-2 py-1 rounded border border-slate-100 shadow-inner tracking-tighter"><i class="far fa-calendar-check mr-1 text-rose-500"></i>${d.date}</span>
                            <span class="text-xs text-slate-400 font-black">【學員：${d.studentName}】</span>
                        </div>
                        <h3 class="adaptive-title text-slate-900 mb-3 leading-tight tracking-tighter font-black">${d.title}</h3>
                        <div class="mb-4 inline-flex items-center gap-2 bg-indigo-50 text-indigo-700 px-3 py-1 rounded-full text-xs font-black border border-indigo-100 italic">
                            <i class="fas fa-user-tie"></i> 評量教師：${d.teacherName}
                        </div>
                        <div class="space-y-2">${d.details.join('')}</div>
                    </div>
                    <div class="flex flex-col justify-center items-end min-w-[140px] border-l-2 border-slate-50 pl-8">
                        ${d.type === 'EPA' ? `<div class="flex flex-col gap-3">${[1,2,3].map(i => `<div class="border-2 rounded-2xl p-2 min-w-[110px] text-center shadow-sm ${getGradeStyle(d.opaScores[i])}"><span class="text-[10px] block uppercase opacity-80 mb-1 font-bold tracking-tighter font-black">OPA ${i}</span><span class="text-4xl font-black">${d.opaScores[i] || '?'}</span></div>`).join('')}</div>` : (['DOPS', 'Mini-CEX', 'CbD'].includes(d.type) ? `<div class="text-center"><div class="adaptive-score text-blue-700 font-mono drop-shadow-xl tracking-tighter font-black">${d.scoreRaw || '--'}</div><div class="adaptive-label text-slate-400 uppercase italic mt-4 tracking-widest font-black text-[11px]">Total Score</div></div>` : (d.type==='Milestone' ? '<div class="text-xs font-black text-slate-300 uppercase italic">Level Based</div>' : ''))}
                    </div></div>`).join('');
        }

        function generateCompareTables() {
            const container = document.getElementById('compareContainer'); 
            if(!container) return;
            container.innerHTML = "";
            const filtered = getFilteredData();
            const sorted = sortDataList([...filtered]); if (sorted.length === 0) return;
            
            let html = `<div class="mb-4 border-b-2 border-slate-900 pb-1 flex justify-between items-center"><h2 class="adaptive-title text-slate-900 uppercase italic tracking-tighter"><i class="fas fa-chart-line text-rose-500 mr-2"></i>學前 / 學中 / 學後 成長對照總表 (由遠而近)</h2></div>`;
            const getTeacherRow = (list) => `<tr><td class="font-black text-indigo-600 text-center text-xs tracking-tighter bg-indigo-50/50">評量教師</td>${list.map(d => `<td class="text-center font-black text-indigo-700 bg-indigo-50/20 text-xs">${d.teacherName}</td>`).join('')}</tr>`;
            const getStudentRow = (list) => `<tr><td class="font-black text-blue-600 text-center text-xs tracking-tighter bg-blue-50/50">受評學員</td>${list.map(d => `<td class="text-center font-black text-blue-700 bg-blue-50/20 text-xs">${d.studentName}</td>`).join('')}</tr>`;

            const msGroups = {}; sorted.filter(d => d.type === 'Milestone').forEach(d => { if(!msGroups[d.studentName]) msGroups[d.studentName]=[]; msGroups[d.studentName].push(d); });
            for(let sName in msGroups) {
                html += `<div class="bg-white rounded-3xl p-4 shadow-xl mb-8 border border-slate-200 overflow-x-auto slide-up"><h3 class="text-xs font-black text-rose-600 mb-2 border-b border-rose-100 pb-1 w-fit uppercase font-black tracking-widest italic">Milestone 成長比對：${sName}</h3><table class="compare-table"><thead><tr><th class="text-slate-400 w-1/4 text-left font-black italic tracking-widest text-xs">指標 / 日期</th>${msGroups[sName].map(d => `<th class="font-black text-slate-800 bg-rose-50/50">${d.date}</th>`).join('')}</tr></thead><tbody class="adaptive-text font-black">`; html += getTeacherRow(msGroups[sName]); TARGET_MILESTONES.forEach(target => { html += `<tr><td class="font-bold text-slate-600 border-r border-slate-50 tracking-tighter text-xs">${target}</td>${msGroups[sName].map(d => `<td class="text-center"><span class="px-2 py-1 rounded font-black border ${getGradeStyle(d.milestoneLevels[target])}">${d.milestoneLevels[target] ? 'L'+d.milestoneLevels[target] : '-'}</span></td>`).join('')}</tr>`; }); html += `</tbody></table></div>`;
            }

            const skillData = sorted.filter(d => ['DOPS', 'Mini-CEX', 'CbD'].includes(d.type));
            const skillGroups = {}; skillData.forEach(d => { const gKey = `${d.studentName} | ${getSmartGroupName(d)}`; if(!skillGroups[gKey]) skillGroups[gKey]=[]; skillGroups[gKey].push(d); });
            for(let gKey in skillGroups) {
                const info = gKey.split(' | ');
                html += `<div class="bg-white rounded-3xl p-4 shadow-xl mb-8 border border-slate-200 overflow-x-auto slide-up"><div class="flex items-center gap-2 mb-3 border-b border-slate-100 pb-1"><span class="text-[10px] font-black px-2 py-0.5 rounded bg-indigo-600 text-white uppercase italic shadow-sm tracking-tighter">同人進度比對</span><h3 class="text-sm font-black text-slate-800 tracking-tighter italic">學員：${info[0]} / 部位：${info[1]}</h3></div><table class="compare-table"><thead><tr><th class="w-1/6 text-slate-400 font-bold uppercase text-left tracking-tighter italic text-xs">對照項 / 日期</th>${skillGroups[gKey].map(d => `<th class="font-black text-slate-800 bg-slate-50">${d.date}<br><span class="text-[10px] opacity-60">(${d.type})</span></th>`).join('')}</tr></thead><tbody class="adaptive-text font-black text-slate-700">`; 
                html += getStudentRow(skillGroups[gKey]); html += getTeacherRow(skillGroups[gKey]); 
                html += `<tr><td class="font-black text-slate-400 text-xs tracking-tighter text-center italic">項目題目</td>${skillGroups[gKey].map(d => `<td class="font-bold text-slate-700 bg-slate-50/30 text-xs tracking-tight">${d.skillName}</td>`).join('')}</tr>`; 
                html += `<tr><td class="font-black text-blue-600 italic text-center text-lg">總評分</td>${skillGroups[gKey].map(d => `<td class="text-center adaptive-score text-slate-800 font-mono tracking-tighter font-black">${d.scoreRaw}</td>`).join('')}</tr>`; 
                html += `<tr><td class="font-black text-emerald-700 text-center tracking-tighter">表現良好</td>${skillGroups[gKey].map(d => `<td class="adaptive-feedback text-slate-700 font-bold min-w-[200px] bg-emerald-50/10 leading-snug">${d.feedbackGood || '-'}</td>`).join('')}</tr>`; 
                html += `<tr><td class="font-black text-amber-700 text-center tracking-tighter">建議加強</td>${skillGroups[gKey].map(d => `<td class="adaptive-feedback text-slate-700 font-bold min-w-[200px] bg-amber-50/10 leading-snug">${d.feedbackNeeds || '-'}</td>`).join('')}</tr>`; 
                html += `<tr><td class="font-black text-blue-700 text-center tracking-tighter italic">學員回饋</td>${skillGroups[gKey].map(d => `<td class="adaptive-feedback text-slate-700 font-black min-w-[200px] bg-blue-50/10 leading-snug">${d.studentFeedback || '-'}</td>`).join('')}</tr>`; 
                html += `</tbody></table></div>`;
            }

            const epaData = sorted.filter(d => d.type === 'EPA');
            const epaGroups = {}; epaData.forEach(d => { const g = `${d.studentName} | ${getSmartGroupName(d)}`; if(!epaGroups[g]) epaGroups[g]=[]; epaGroups[g].push(d); });
            for(let part in epaGroups) {
                const info = part.split(' | ');
                html += `<div class="bg-white rounded-3xl p-4 shadow-xl mb-8 border border-slate-200 overflow-x-auto slide-up"><h3 class="text-xs font-black text-blue-600 mb-2 border-b border-blue-100 pb-1 w-fit uppercase italic tracking-tighter font-black tracking-widest">EPA 信賴成長：${info[0]} (${info[1]})</h3><table class="compare-table"><thead><tr><th class="w-1/6 text-slate-400 italic text-left tracking-tighter uppercase italic text-xs">日期 / 指標</th>${epaGroups[part].map(d => `<th class="font-black text-slate-800 bg-blue-50/50">${d.date}</th>`).join('')}</tr></thead><tbody class="adaptive-text">`; html += getStudentRow(epaGroups[part]); html += getTeacherRow(epaGroups[part]); [1,2,3].forEach(i => { html += `<tr><td class="font-bold text-blue-500 border-t border-slate-50 pt-2 uppercase tracking-tighter font-black text-center text-xs">OPA ${i}</td>${epaGroups[part].map(d => `<td class="text-center pt-2 border-t border-slate-50"><span class="px-4 py-1.5 rounded-xl font-black text-2xl border-2 shadow-sm ${getGradeStyle(d.opaScores[i])}">${d.opaScores[i] || '-'}</span></td>`).join('')}</tr>`; html += `<tr><td class="text-xs font-black text-slate-400 border-none italic pb-2 text-center tracking-tighter">質性建議</td>${epaGroups[part].map(d => `<td class="adaptive-feedback text-slate-700 min-w-[200px] border-none pb-2 bg-slate-50/20 font-medium leading-tight">${d.opaFeedbacks[i] || '-'}</td>`).join('')}</tr>`; }); html += `</tbody></table></div>`;
            }
            container.innerHTML = html;
        }

        function setFilter(f) { currentFilter = f; document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active-filter')); const target = document.getElementById('f_'+f); if(target) target.classList.add('active-filter'); switchView(currentViewMode()); }
        function setStudentFilter(val) { currentStudentFilter = val; switchView(currentViewMode()); }
        function setTrainingFilter(val) { currentTrainingFilter = val; switchView(currentViewMode()); }
        function toggleSort() { sortDirection = sortDirection === 'desc' ? 'asc' : 'desc'; const icon = document.getElementById('sortIcon'); if(icon) icon.className = `fas fa-sort-amount-${sortDirection === 'desc' ? 'down' : 'up'} text-rose-500`; const txt = document.getElementById('sortText'); if(txt) txt.innerText = `日期：${sortDirection === 'desc' ? '新到舊' : '舊到新'}`; switchView(currentViewMode()); }
        function currentViewMode() { if(document.getElementById('cardModeBtn')?.classList.contains('mode-active')) return 'card'; if(document.getElementById('compareModeBtn')?.classList.contains('mode-active')) return 'compare'; return 'chart'; }
        function sortDataList(list) { return list.sort((a, b) => sortDirection === 'desc' ? b.date.localeCompare(a.date) : a.date.localeCompare(b.date)); }
        function hexToRgba(hex, alpha) { const r = parseInt(hex.slice(1, 3), 16), g = parseInt(hex.slice(3, 5), 16), b = parseInt(hex.slice(5, 7), 16); return `rgba(${r}, ${g}, ${b}, ${alpha})`; }

        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(e => { if(dropZone) dropZone.addEventListener(e, (evt) => { evt.preventDefault(); evt.stopPropagation(); }, false); });
        if(dropZone) dropZone.addEventListener('drop', (e) => handleFiles(e.dataTransfer.files));
        if(dropZone) dropZone.onclick = () => fileInput.click();
        if(fileInput) fileInput.onchange = (e) => handleFiles(e.target.files);

        async function handleFiles(files) { 
            if (!files || files.length === 0) return; 
            document.getElementById('progressOverlay').classList.remove('hidden'); 
            try {
                for (let i = 0; i < files.length; i++) { 
                    const text = await files[i].text(); 
                    const result = files[i].name.toLowerCase().endsWith('.csv') ? analyzeCSV(text) : analyzeHTML(text);
                    if (result) { if (Array.isArray(result)) historyData.push(...result); else historyData.push(result); }
                } 
            } catch(e) {}
            document.getElementById('progressOverlay').classList.add('hidden'); 
            updateFilterOptions();
            switchView('card'); 
        }

        function updateFilterOptions() {
            const sSelect = document.getElementById('studentFilter');
            const tSelect = document.getElementById('trainingFilter');
            if(!sSelect || !tSelect) return;
            const students = [...new Set(historyData.map(d => d.studentName))].sort();
            const trainings = [...new Set(historyData.map(d => d.trainingType))].sort();
            sSelect.innerHTML = '<option value="all">所有學員</option>';
            students.forEach(s => { sSelect.innerHTML += `<option value="${s}" ${s===currentStudentFilter?'selected':''}>${s}</option>`; });
            tSelect.innerHTML = '<option value="all">所有訓練別</option>';
            trainings.forEach(t => { tSelect.innerHTML += `<option value="${t}" ${t===currentTrainingFilter?'selected':''}>${t}</option>`; });
        }

        function getFilteredData() {
            let data = currentFilter === 'all' ? historyData : historyData.filter(d => d.type === currentFilter);
            if (currentStudentFilter !== 'all') data = data.filter(d => d.studentName === currentStudentFilter);
            if (currentTrainingFilter !== 'all') data = data.filter(d => d.trainingType === currentTrainingFilter);
            return data;
        }

        function exportToCSV() { if (historyData.length === 0) return; let hs = ["評量日期", "學員姓名", "類型", "表單名稱", "總分", "操作項目", "OPA1成績", "OPA1回饋", "OPA2成績", "OPA2回饋", "OPA3成績", "OPA3回饋", "表現良好項目", "建議加強項目", "學員心得回饋", "教師姓名", "訓練別編號"]; TARGET_MILESTONES.forEach(m => hs.push(m)); let rows = [hs.join(',')]; sortDataList([...historyData]).forEach(item => { let r = [item.date, item.studentName, item.type, item.title, (item.type !== 'EPA' ? item.scoreRaw : ''), item.skillName, item.opaScores[1], item.opaFeedbacks[1], item.opaScores[2], item.opaFeedbacks[2], item.opaScores[3], item.opaFeedbacks[3], item.feedbackGood, item.feedbackNeeds, item.studentFeedback, item.teacherName, item.trainingType]; TARGET_MILESTONES.forEach(m => r.push(item.milestoneLevels[m] || '')); rows.push(r.map(v => `"${(v || '').toString().replace(/"/g, '""')}"`).join(',')); }); const blob = new Blob(["\ufeff" + rows.join('\n')], { type: 'text/csv;charset=utf-8;' }); const link = document.createElement("a"); link.href = URL.createObjectURL(blob); link.download = `醫學成果對照表.csv`; link.click(); }
    </script>
</body>
</html>
