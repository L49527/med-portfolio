<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>醫學評量批次助手 v24.3.23</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            /* 核心流體縮放：字體隨寬度線性調整 */
            font-size: clamp(12px, 0.95vw, 16px);
        }
        body { font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif; background-color: #f8fafc; overflow: hidden; }
        
        /* 側邊欄抽屜 */
        #sidebar { transition: all 0.2s ease-in-out; width: 60px; }
        #sidebar.expanded { width: 300px; }
        #sidebarContent { opacity: 0; visibility: hidden; transition: opacity 0.15s; }
        #sidebar.expanded #sidebarContent { opacity: 1; visibility: visible; }

        /* 流體字體組 */
        .adaptive-text { font-size: 0.95rem; line-height: 1.5; }
        .adaptive-feedback { font-size: 1.05rem; font-weight: 600; line-height: 1.6; color: #0f172a; }
        .adaptive-title { font-size: 1.4rem; font-weight: 900; letter-spacing: -0.02em; }
        .adaptive-score { font-size: clamp(30px, 3vw, 80px); font-weight: 1000; line-height: 1; }
        
        /* 互比表格：強迫自適應單頁 */
        .compare-table { width: 100%; table-layout: fixed; border-collapse: collapse; }
        .compare-table th { 
            background-color: #f8fafc; position: sticky; top: 0; z-index: 10; 
            border-bottom: 2px solid #e2e8f0; padding: 0.5rem; 
            font-size: 0.8rem; font-weight: 800; text-align: center;
        }
        .compare-table td { 
            padding: clamp(6px, 0.6vw, 12px); border-right: 1px solid #f1f5f9; border-bottom: 1px solid #f1f5f9; 
            vertical-align: top; word-break: break-all; overflow: hidden;
        }
        .compare-table tr:hover { background-color: #f0f9ff; }
        
        .filter-btn { background-color: #f1f5f9; color: #64748b; border: 1px solid #e2e8f0; }
        .filter-btn.active-filter { background-color: #e11d48; color: white; border-color: #e11d48; box-shadow: 0 4px 6px -1px rgb(225 29 72 / 0.3); }
        .vertical-text { writing-mode: vertical-lr; letter-spacing: 0.1em; }
        .slide-up { animation: slideUp 0.3s ease-out forwards; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="h-screen flex flex-col text-slate-800 bg-slate-50">

    <!-- 頂部導覽列 -->
    <header class="bg-slate-900 text-white px-6 py-3 flex justify-between items-center shadow-xl z-40">
        <div class="flex items-center gap-4">
            <div class="bg-rose-500 p-0.5 rounded-lg shadow-lg">
                <div class="bg-slate-900 rounded p-1.5 w-8 h-8 flex items-center justify-center font-bold text-rose-400 text-lg font-mono">24</div>
            </div>
            <div>
                <h1 class="text-base font-black text-white leading-tight">醫學評量批次助手 <span class="text-rose-400 font-mono">v24.3.23</span></h1>
                <p class="text-[10px] text-slate-400 italic tracking-widest uppercase">Fluid Adaptive Scaling Mode</p>
            </div>
        </div>
        
        <div class="flex gap-3">
            <button id="toggleModeBtn" onclick="toggleCompareMode()" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-1.5 rounded-xl font-black transition flex items-center gap-2 shadow-md border-b-4 border-blue-900 active:translate-y-0.5 active:border-b-0">
                <i class="fas fa-right-left text-sm"></i> <span id="compareBtnText" class="text-sm">進入互比模式</span>
            </button>
            <button onclick="exportToCSV()" class="bg-emerald-600 hover:bg-emerald-700 text-white px-5 py-1.5 rounded-xl font-black transition flex items-center gap-2 shadow-md text-sm">
                <i class="fas fa-file-csv"></i> 匯出 CSV
            </button>
            <button onclick="clearHistory()" class="bg-slate-800 hover:bg-red-600 text-slate-300 hover:text-white px-3 py-1.5 rounded-lg transition text-xs">
                <i class="fas fa-trash-alt"></i>
            </button>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden relative">
        <!-- 左側側邊欄 -->
        <div id="sidebar" class="bg-white border-r border-slate-200 flex flex-col shadow-xl z-30">
            <button onclick="toggleSidebar()" class="w-full py-6 flex flex-col items-center gap-3 hover:bg-rose-50 text-rose-600 transition-colors border-b border-slate-100 text-center">
                <i id="sidebarIcon" class="fas fa-angles-right text-xl"></i>
                <span id="sidebarBtnLabel" class="text-[9px] font-black uppercase vertical-text">開啟匯入</span>
            </button>
            <div id="sidebarContent" class="p-4 flex-1 flex flex-col overflow-hidden text-center">
                <div class="mb-4 text-rose-600 font-bold flex items-center gap-2"><i class="fas fa-file-circle-plus"></i><span class="text-sm tracking-tighter">檔案批次匯入</span></div>
                <div id="dropZone" class="border-2 border-dashed border-slate-300 rounded-2xl flex-1 flex flex-col items-center justify-center p-4 transition hover:border-rose-400 hover:bg-rose-50 group cursor-pointer shadow-inner bg-slate-50">
                    <i class="fas fa-cloud-arrow-up text-4xl text-slate-300 group-hover:text-rose-400 mb-4 transition-all"></i>
                    <p class="text-[11px] font-bold text-slate-400 group-hover:text-rose-600 leading-tight">全選 HTML<br>拖放到這裡</p>
                    <input type="file" id="fileInput" multiple accept=".html,.htm" class="hidden">
                </div>
            </div>
        </div>

        <!-- 右側主區域 -->
        <div class="flex-1 flex flex-col bg-slate-100 overflow-hidden relative">
            <!-- 篩選列 -->
            <div class="bg-white px-8 py-2 border-b border-slate-200 flex items-center justify-between shadow-sm z-10">
                <div class="flex items-center gap-2 scale-90 origin-left">
                    <button onclick="setFilter('all')" id="f_all" class="filter-btn active-filter px-4 py-1 rounded-full text-xs font-bold transition">全部</button>
                    <button onclick="setFilter('Milestone')" id="f_Milestone" class="filter-btn px-4 py-1 rounded-full text-xs font-bold transition text-rose-600">里程碑</button>
                    <button onclick="setFilter('DOPS')" id="f_DOPS" class="filter-btn px-4 py-1 rounded-full text-xs font-bold transition text-purple-600">DOPS</button>
                    <button onclick="setFilter('Mini-CEX')" id="f_Mini-CEX" class="filter-btn px-4 py-1 rounded-full text-xs font-bold transition text-orange-600">Mini-CEX</button>
                    <button onclick="setFilter('EPA')" id="f_EPA" class="filter-btn px-4 py-1 rounded-full text-xs font-bold transition text-blue-600">EPA</button>
                </div>
                <button onclick="toggleSort()" class="bg-slate-50 hover:bg-rose-50 text-slate-600 px-3 py-1 rounded-lg text-xs font-bold transition flex items-center gap-2 border border-slate-200">
                    <i class="fas fa-arrows-up-down text-rose-500" id="sortIcon"></i>
                    <span id="sortText">日期：新到舊</span>
                </button>
            </div>
            <!-- 卡片容器 -->
            <div class="flex-1 p-6 overflow-y-auto" id="historyContainer">
                <div id="emptyState" class="h-full flex flex-col items-center justify-center text-slate-300 opacity-40 text-center leading-loose">
                    <i class="fas fa-layer-group text-9xl mb-6 text-slate-200"></i>
                    <p class="text-xl font-light tracking-widest uppercase italic">請由左側展開並匯入檔案</p>
                </div>
            </div>
            <!-- 互比容器 -->
            <div class="hidden flex-1 p-6 overflow-auto bg-white" id="compareContainer"></div>
        </div>
    </div>

    <!-- 進度條 -->
    <div id="progressOverlay" class="hidden fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-50 flex items-center justify-center">
        <div class="bg-white p-8 rounded-3xl shadow-2xl flex flex-col items-center max-w-sm w-full border border-slate-100">
            <div class="loading-ring mb-4"></div>
            <p id="progressText" class="font-bold text-lg text-slate-700">智慧分組中...</p>
            <div class="w-full bg-slate-100 h-2 rounded-full mt-6 overflow-hidden shadow-inner">
                <div id="progressBar" class="bg-rose-500 h-full transition-all duration-300" style="width: 0%"></div>
            </div>
        </div>
    </div>

    <script>
        let historyData = [];
        let currentFilter = 'all';
        let sortDirection = 'desc';
        let isCompareMode = false;

        const TARGET_MILESTONES = ["一、醫學影像及放射科學知識 1：放射診斷造影相關知識能力","一、醫學影像及放射科學知識 2：儀器品保與輻射安全","二、醫病關係及團隊溝通能力 1：與其他專業團隊之有效溝通","二、醫病關係及團隊溝通能力 2：與病人及陪同者之妥善溝通","三、病人照護 1：放射診斷造影技術","三、病人照護 2：儀器設備異常狀況處理","三、病人照護 3：病人安全","三、病人照護 4：任務交接","三、病人照護 5：跨領域團隊合作照護","四、提升本職技能 1： 提升本職技能","五、專業素養 1：專業價值","五、專業素養 2：責任擔當"];

        function getGradeStyle(val) {
            if (!val) return 'bg-slate-50 text-slate-300';
            const v = val.toString().toUpperCase().trim();
            if (v === '5') return 'bg-indigo-600 text-white border-indigo-700 shadow-sm';
            if (v === '4') return 'bg-emerald-500 text-white border-emerald-600 shadow-sm';
            if (v === '3C') return 'bg-sky-500 text-white border-sky-600';
            if (v === '3B') return 'bg-blue-400 text-white border-blue-500';
            if (v === '3A') return 'bg-cyan-400 text-slate-800 border-cyan-500';
            if (v === '2B') return 'bg-amber-500 text-white border-amber-600';
            if (v === '2A') return 'bg-orange-300 text-slate-800 border-orange-400';
            if (v === '1') return 'bg-rose-500 text-white border-rose-600';
            if (v === 'N/A') return 'bg-slate-300 text-slate-600 border-slate-400';
            return 'bg-slate-100 text-slate-500';
        }

        // --- 核心：智慧互比分組技術 ---
        function getSmartGroupName(item) {
            const title = item.title;
            const type = item.type;
            let keyword = "";

            if (title.includes("頭頸部")) keyword = "頭頸部";
            else if (title.includes("胸腹部") || title.includes("胸部") || title.includes("腹部")) keyword = "胸腹部";
            else if (title.includes("CTA") || title.includes("Dynamic")) keyword = "CTA/Dynamic造影";
            else if (title.includes("學前")) keyword = "學前測驗";
            else if (title.includes("學中")) keyword = "學中測驗";
            else if (title.includes("學後")) keyword = "學後測驗";
            
            // 如果沒中關鍵字，自動抓取類別後的名稱
            if (!keyword) {
                keyword = title.replace(/^(DOPS|Mini-CEX|CEX|EPA|Milestone)[-\s:_/]+/i, '').trim().split(/[-_\s/]/)[0] || "其他項目";
            }
            return `互比 ${type} - ${keyword}`;
        }

        function analyzeHTML(raw) {
            const textStream = raw.replace(/(\r\n|\n|\r)/gm, " ").replace(/\s+/g, " ");
            const parser = new DOMParser();
            const doc = parser.parseFromString(raw, 'text/html');
            let item = { id: Math.random().toString(36).substr(2, 9), type: 'Unknown', title: doc.querySelector('title')?.textContent.trim() || (textStream.match(/(DOPS|EPA|Mini-CEX|Milestone|里程碑)[^\n<]*/i)?.[0] || "未定義"), date: '1900-01-01', scoreRaw: '', skillName: '', feedbackGood: '', feedbackNeeds: '', studentFeedback: '', opaScores: { 1: '', 2: '', 3: '' }, opaFeedbacks: { 1: '', 2: '', 3: '' }, milestoneLevels: {}, details: [] };
            
            let dateMatch = raw.match(/DateType[^>]*?value=["'](\d{4}[-\/]\d{1,2}[-\/]\d{1,2})["']/i);
            item.date = dateMatch ? dateMatch[1].replace(/\//g, '-') : (raw.match(/20\d{2}[-\/]\d{1,2}[-\/]\d{1,2}/g)?.pop()?.replace(/\//g, '-') || "1900-01-01");

            const upTitle = item.title.toUpperCase();
            if (upTitle.includes('DOPS')) item.type = 'DOPS';
            else if (upTitle.includes('CEX') || upTitle.includes('MINI-CEX')) item.type = 'Mini-CEX';
            else if (upTitle.includes('EPA')) item.type = 'EPA';
            else if (upTitle.includes('MILESTONE') || upTitle.includes('里程碑')) item.type = 'Milestone';

            // 深度資料提取引擎
            if (item.type === 'DOPS' || item.type === 'Mini-CEX') {
                item.scoreRaw = textStream.match(/(?:評量總分數|評量成績|總分)[^0-9]{0,20}(\d{1,3}(\.\d)?)/i)?.[1] || "--";
                item.skillName = textStream.match(/(?:操作項目|技能名稱|題目)[^<:：]{0,30}[:：]?\s*(?:<[^>]+>\s*)*([^<>\s][^<]{2,150})/i)?.[1]?.trim() || "未指定";
                
                item.feedbackGood = textStream.match(/(?:教師回饋意見-表現良好項目|表現良好項目)[^<:：]{0,30}[:：]?\s*(?:<[^>]+>\s*)*([^<>\s][^<]{1,3000})/i)?.[1] || "";
                item.feedbackNeeds = textStream.match(/(?:教師回饋意見-建議加強項目|建議加強項目)[^<:：]{0,30}[:：]?\s*(?:<[^>]+>\s*)*([^<>\s][^<]{1,3000})/i)?.[1] || "";
                
                // 學員心得心得回饋抓取修復 (支援 Textarea)
                let stuM = textStream.match(/(?:學員回饋意見|自評意見|學員心得)[\s\S]*?(?:<textarea[^>]*>)?([\s\S]*?)(?:<\/textarea>|<div)/i);
                item.studentFeedback = stuM ? stuM[1].replace(/<[^>]*>?/gm, '').trim() : "";

                if(item.skillName) item.details.push(`<div class="bg-slate-200 p-2 px-3 rounded-lg text-[13px] font-black border-l-4 border-slate-500 mb-2">項目：${item.skillName}</div>`);
                if(item.feedbackGood) item.details.push(`<div class="adaptive-text mb-1"><span class="text-emerald-700 font-bold mr-1 italic">【良好】</span>${item.feedbackGood}</div>`);
                if(item.feedbackNeeds) item.details.push(`<div class="adaptive-text mb-1"><span class="text-amber-700 font-bold mr-1 italic">【建議】</span>${item.feedbackNeeds}</div>`);
                if(item.studentFeedback) item.details.push(`<div class="adaptive-text bg-blue-50 p-2 rounded border border-blue-100 italic text-slate-700 mt-1 font-medium shadow-inner leading-snug"><span class="text-blue-700 font-black mr-2">學員心得:</span>${item.studentFeedback}</div>`);
            } else if (item.type === 'EPA') {
                let opaSections = raw.split(/一、主題：/i).slice(1); 
                opaSections.forEach((section, index) => {
                    if (index < 3) {
                        let i = index + 1;
                        let scoreMatch = section.match(/整體任務[\s\S]*?<input[^>]*checked[^>]*>[\s\S]*?<label[^>]*?>\s*([^<]+?)\s*<\/label>/i);
                        if (scoreMatch) item.opaScores[i] = scoreMatch[1].trim();
                        let fbMatch = section.match(/其它質性回饋[\s\S]*?回饋[：:][\s\S]*?<textarea[^>]*>([\s\S]*?)<\/textarea>/i);
                        if (fbMatch) item.opaFeedbacks[i] = fbMatch[1].trim();
                        item.details.push(`<div class="mt-1 border-l-2 border-blue-400 pl-3 py-1 bg-white rounded shadow-sm border border-slate-100"><div class="flex justify-between items-center mb-0.5"><span class="adaptive-label text-blue-400 uppercase font-bold">OPA ${i}</span><span class="px-2 py-0.5 rounded text-[10px] font-black border ${getGradeStyle(item.opaScores[i])}">${item.opaScores[i] || '?'}</span></div><div class="adaptive-text text-slate-700">${item.opaFeedbacks[i] || '無建議'}</div></div>`);
                    }
                });
            } else if (item.type === 'Milestone') {
                TARGET_MILESTONES.forEach(target => {
                    let loc = textStream.search(new RegExp(target.replace(/[.*+?^${}()|[\]\\]/g, '\\$&').replace(/\s+/g, "\\s*"), 'i'));
                    if (loc > -1) {
                        let checked = textStream.substring(loc, loc + 5000).match(/<input[^>]*?\bchecked\b[^>]*?>[^<]*?<label[^>]*?>\s*Level\s*([1-5])/i);
                        if (checked) { item.milestoneLevels[target] = checked[1]; item.details.push(`<div class="flex justify-between items-center py-0.5 border-b border-slate-50 adaptive-text"><span class="text-slate-700 font-medium tracking-tighter">${target}</span><span class="px-2 py-0.5 rounded font-black border ${getGradeStyle(checked[1])}">L${checked[1]}</span></div>`); }
                    }
                });
            }
            return item;
        }

        function generateCompareTables() {
            const container = document.getElementById('compareContainer');
            const sorted = sortDataList([...historyData]);
            if (sorted.length === 0) { container.innerHTML = `<p class="text-center text-slate-400 p-20 text-xl font-light italic">請匯入檔案以生成對照表</p>`; return; }

            let html = `<div class="mb-4 border-b-2 border-slate-900 pb-1 flex justify-between items-center"><h2 class="adaptive-title text-slate-900 uppercase italic tracking-tighter"><i class="fas fa-chart-line text-rose-500 mr-2"></i>行政智慧互比彙整表</h2><span class="text-[10px] text-slate-400">視窗寬度自適應模式</span></div>`;

            if (currentFilter === 'all' || currentFilter === 'Milestone') {
                const msData = sorted.filter(d => d.type === 'Milestone');
                if (msData.length > 0) {
                    html += `<div class="bg-white rounded-2xl p-4 shadow-xl mb-6 border border-slate-200 overflow-x-auto slide-up">
                        <h3 class="text-xs font-black text-rose-600 mb-2 border-b border-rose-100 pb-1 w-fit uppercase">互比 Milestone</h3>
                        <table class="compare-table"><thead><tr><th class="text-slate-400 w-1/4 text-left">評量指標</th>${msData.map(d => `<th class="font-black text-slate-800 bg-rose-50/50">${d.date}</th>`).join('')}</tr></thead><tbody class="adaptive-text">`;
                    TARGET_MILESTONES.forEach(target => {
                        html += `<tr><td class="font-bold text-slate-600 border-r border-slate-50 tracking-tighter">${target}</td>${msData.map(d => {
                            let lv = d.milestoneLevels[target];
                            return `<td class="text-center"><span class="px-2 py-0.5 rounded font-black border ${getGradeStyle(lv)}">${lv ? 'L'+lv : '-'}</span></td>`;
                        }).join('')}</tr>`;
                    });
                    html += `</tbody></table></div>`;
                }
            }

            const dopsCexData = sorted.filter(d => d.type === 'DOPS' || d.type === 'Mini-CEX');
            if (dopsCexData.length > 0) {
                const groups = {};
                dopsCexData.forEach(d => { const g = getSmartGroupName(d); if(!groups[g]) groups[g]=[]; groups[g].push(d); });
                for(let gName in groups) {
                    if(currentFilter !== 'all' && !groups[gName].some(d => d.type === currentFilter)) continue;
                    html += `<div class="bg-white rounded-2xl p-4 shadow-xl mb-6 border border-slate-200 overflow-x-auto slide-up">
                        <div class="flex items-center gap-2 mb-3 border-b border-slate-100 pb-1">
                            <span class="text-[10px] font-black px-2 py-0.5 rounded bg-indigo-600 text-white uppercase italic shadow-sm">互比分組</span>
                            <h3 class="text-sm font-black text-slate-800 tracking-tighter">${gName}</h3>
                        </div>
                        <table class="compare-table"><thead><tr><th class="w-1/6 text-slate-400 font-bold uppercase text-left tracking-tighter italic">對照項 / 日期</th>${groups[gName].map(d => `
                            <th class="font-black text-slate-800 bg-slate-50">${d.date}</th>`).join('')}</tr></thead><tbody class="adaptive-text">`;
                    html += `<tr><td class="font-black text-slate-400 text-xs tracking-tighter">技能題目</td>${groups[gName].map(d => `<td class="font-bold text-slate-700 bg-slate-50/30 text-[12px]">${d.skillName}</td>`).join('')}</tr>`;
                    html += `<tr><td class="font-black text-blue-600 italic">總分</td>${groups[gName].map(d => `<td class="text-center adaptive-score text-slate-800 font-mono tracking-tighter">${d.scoreRaw}</td>`).join('')}</tr>`;
                    html += `<tr><td class="font-black text-emerald-700">良好建議</td>${groups[gName].map(d => `<td class="adaptive-feedback text-slate-700 min-w-[180px] bg-emerald-50/10 rounded-xl leading-snug">${d.feedbackGood || '-'}</td>`).join('')}</tr>`;
                    html += `<tr><td class="font-black text-amber-700">加強建議</td>${groups[gName].map(d => `<td class="adaptive-feedback text-slate-700 min-w-[180px] bg-amber-50/10 rounded-xl leading-snug">${d.feedbackNeeds || '-'}</td>`).join('')}</tr>`;
                    html += `<tr><td class="font-black text-blue-700 italic">學員回饋</td>${groups[gName].map(d => `<td class="adaptive-feedback italic text-slate-600 min-w-[180px] bg-blue-50/10 shadow-inner leading-snug font-bold">${d.studentFeedback || '-'}</td>`).join('')}</tr>`;
                    html += `</tbody></table></div>`;
                }
            }

            if (currentFilter === 'all' || currentFilter === 'EPA') {
                const epaData = sorted.filter(d => d.type === 'EPA');
                if (epaData.length > 0) {
                    html += `<div class="bg-white rounded-2xl p-4 shadow-xl mb-6 border border-slate-200 overflow-x-auto slide-up">
                        <h3 class="text-xs font-black text-blue-600 mb-2 border-b border-blue-100 pb-1 w-fit uppercase italic tracking-tighter text-left">互比 EPA (OPA 1-3)</h3>
                        <table class="compare-table"><thead><tr><th class="w-1/6 text-slate-400 italic text-left tracking-tighter">OPA指標 / 日期</th>${epaData.map(d => `<th class="font-black text-slate-800 bg-blue-50/50">${d.date}</th>`).join('')}</tr></thead><tbody class="adaptive-text">`;
                    [1,2,3].forEach(i => {
                        html += `<tr><td class="font-bold text-blue-500 border-t border-slate-50 pt-2 uppercase tracking-tighter">OPA ${i} 成績</td>${epaData.map(d => `<td class="text-center pt-2 border-t border-slate-50"><span class="px-3 py-1 rounded-xl font-black text-2xl border-2 shadow-sm ${getGradeStyle(d.opaScores[i])}">${d.opaScores[i] || '-'}</span></td>`).join('')}</tr>`;
                        html += `<tr><td class="adaptive-label text-slate-400 border-none italic pb-2 text-center tracking-tighter">質性建議</td>${epaData.map(d => `<td class="adaptive-feedback text-slate-700 min-w-[180px] border-none pb-2 bg-slate-50/20 font-medium leading-tight">${d.opaFeedbacks[i] || '-'}</td>`).join('')}</tr>`;
                    });
                    html += `</tbody></table></div>`;
                }
            }
            container.innerHTML = html;
        }

        // --- 基本控制 ---
        function toggleSidebar() {
            const sb = document.getElementById('sidebar');
            const icon = document.getElementById('sidebarIcon');
            const label = document.getElementById('sidebarBtnLabel');
            sb.classList.toggle('expanded');
            icon.className = sb.classList.contains('expanded') ? 'fas fa-angles-left text-xl' : 'fas fa-angles-right text-xl';
            label.innerText = sb.classList.contains('expanded') ? '收合匯入' : '開啟匯入';
        }
        function setFilter(f) {
            currentFilter = f;
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active-filter'));
            document.getElementById('f_' + f).classList.add('active-filter');
            if (isCompareMode) generateCompareTables(); else render();
        }
        function toggleCompareMode() {
            isCompareMode = !isCompareMode;
            document.getElementById('historyContainer').classList.toggle('hidden', isCompareMode);
            document.getElementById('compareContainer').classList.toggle('hidden', !isCompareMode);
            document.getElementById('compareBtnText').innerText = isCompareMode ? "卡片模式" : "互比模式";
            if (isCompareMode) generateCompareTables();
        }
        function toggleSort() {
            sortDirection = sortDirection === 'desc' ? 'asc' : 'desc';
            document.getElementById('sortIcon').className = sortDirection === 'desc' ? 'fas fa-sort-amount-down' : 'fas fa-sort-amount-up';
            document.getElementById('sortText').innerText = sortDirection === 'desc' ? '日期：新到舊' : '日期：舊到新';
            if (isCompareMode) generateCompareTables(); else render();
        }
        function sortDataList(list) { return list.sort((a, b) => sortDirection === 'desc' ? b.date.localeCompare(a.date) : a.date.localeCompare(b.date)); }

        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        dropZone.addEventListener('click', (e) => { e.stopPropagation(); fileInput.click(); });
        fileInput.addEventListener('change', (e) => handleFiles(e.target.files));
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('bg-rose-50', 'border-rose-400'); });
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('bg-rose-50', 'border-rose-400'));
        dropZone.addEventListener('drop', (e) => { e.preventDefault(); dropZone.classList.remove('bg-rose-50', 'border-rose-400'); handleFiles(e.dataTransfer.files); });

        async function handleFiles(files) {
            if (!files || files.length === 0) return;
            document.getElementById('progressOverlay').classList.remove('hidden');
            for (let i = 0; i < files.length; i++) {
                try {
                    document.getElementById('progressText').innerText = `正在分析檔案 (${i+1}/${files.length})`;
                    document.getElementById('progressBar').style.width = `${((i+1) / files.length) * 100}%`;
                    const text = await files[i].text();
                    historyData.push(analyzeHTML(text));
                } catch (err) { console.error("解析失敗:", files[i].name); }
            }
            document.getElementById('progressOverlay').classList.add('hidden');
            if (isCompareMode) generateCompareTables(); else render();
        }

        function render() {
            const container = document.getElementById('historyContainer');
            let filtered = currentFilter === 'all' ? historyData : historyData.filter(d => d.type === currentFilter);
            filtered = sortDataList([...filtered]);
            if (filtered.length === 0) { container.innerHTML = `<div class="h-full flex flex-col items-center justify-center text-slate-300 opacity-40 text-center"><i class="fas fa-layer-group text-9xl mb-6"></i><p class="text-xl">請匯入學員檔案</p></div>`; return; }
            container.innerHTML = filtered.map(d => `
                <div class="bg-white rounded-3xl p-6 mb-6 shadow-xl border border-slate-200 flex justify-between gap-6 slide-up relative group">
                    <button onclick="deleteItem('${d.id}')" class="absolute top-4 right-4 text-slate-200 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-all text-xl"><i class="fas fa-circle-xmark"></i></button>
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-3 mb-2">
                            <span class="adaptive-label px-3 py-1 rounded-lg ${d.type === 'EPA' ? 'bg-blue-600' : (d.type === 'Milestone' ? 'bg-rose-600' : (d.type === 'DOPS' ? 'bg-purple-600' : 'bg-orange-500'))} text-white uppercase shadow-md tracking-tighter">${d.type}</span>
                            <span class="text-sm text-slate-500 font-bold bg-slate-50 px-2 py-1 rounded border border-slate-100 shadow-inner"><i class="far fa-calendar-check mr-1 text-rose-500"></i>${d.date}</span>
                        </div>
                        <h3 class="adaptive-title text-slate-900 mb-3 leading-tight tracking-tighter">${d.title}</h3>
                        <div class="space-y-2">${d.details.join('')}</div>
                    </div>
                    <div class="flex flex-col justify-center items-end min-w-[140px] border-l-2 border-slate-50 pl-6">
                        ${d.type === 'EPA' ? `<div class="flex flex-col gap-3">${[1,2,3].map(i => `<div class="border-2 rounded-2xl p-2 min-w-[100px] text-center shadow-md ${getGradeStyle(d.opaScores[i])}"><span class="adaptive-label block uppercase opacity-80 mb-1 font-bold">OPA ${i}</span><span class="text-4xl font-black">${d.opaScores[i] || '?'}</span></div>`).join('')}</div>` : (d.type === 'DOPS' || d.type === 'Mini-CEX' ? `<div class="text-center"><div class="adaptive-score text-blue-700 font-mono drop-shadow-xl tracking-tighter">${d.scoreRaw}</div><div class="adaptive-label text-slate-400 uppercase italic mt-4 tracking-widest font-black">Total Score</div></div>` : '')}
                    </div>
                </div>`).join('');
        }
        function deleteItem(id) { historyData = historyData.filter(i => i.id !== id); if(isCompareMode) generateCompareTables(); else render(); }
        function clearHistory() { if(confirm('確定清空？')) { historyData = []; render(); if(isCompareMode) generateCompareTables(); } }
        function exportToCSV() {
            if (historyData.length === 0) return;
            let headers = ["評量日期", "類型", "表單名稱", "總分", "操作項目", "OPA1成績", "OPA1回饋", "OPA2成績", "OPA2回饋", "OPA3成績", "OPA3回饋", "教師良好回饋", "教師待加強回饋", "學員心得回饋"];
            TARGET_MILESTONES.forEach(m => headers.push(m));
            let rows = [headers.join(',')];
            sortDataList([...historyData]).forEach(item => {
                let row = [item.date, item.type, item.title, (item.type !== 'EPA' ? item.scoreRaw : ''), item.skillName, item.opaScores[1], item.opaFeedbacks[1], item.opaScores[2], item.opaFeedbacks[2], item.opaScores[3], item.opaFeedbacks[3], item.feedbackGood, item.feedbackNeeds, item.studentFeedback];
                TARGET_MILESTONES.forEach(m => row.push(item.milestoneLevels[m] || ''));
                rows.push(row.map(v => `"${(v || '').toString().replace(/"/g, '""')}"`).join(','));
            });
            const blob = new Blob(["\ufeff" + rows.join('\n')], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `醫學行政對照總表_${new Date().toLocaleDateString()}.csv`;
            link.click();
        }
    </script>
</body>
</html>
